# 班组管理系统 - 生产部署指南

## 📦 系统要求

- **Python**: 3.8 或更高版本
- **操作系统**: Linux / macOS / Windows
- **内存**: 建议 2GB 以上
- **磁盘空间**: 建议 1GB 以上（用于数据库、日志、上传文件）

---

## 🚀 快速部署（5分钟上线）

### 1. 解压并进入项目目录
```bash
cd 源码/
```

### 2. 创建Python虚拟环境
```bash
# Linux/macOS
python3 -m venv .venv
source .venv/bin/activate

# Windows
python -m venv .venv
.venv\Scripts\activate
```

### 3. 安装依赖
```bash
pip install -r requirements.txt
```

### 4. 配置环境变量
```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑 .env 文件，至少修改以下内容：
# - APP_USER: 管理员用户名
# - APP_PASS: 管理员密码（必须使用强密码）
# - SECRET_KEY: Flask密钥（生产环境必须修改）
```

**生成随机SECRET_KEY**:
```bash
python -c "import os; print(os.urandom(24).hex())"
```

### 5. 首次运行（自动初始化数据库）
```bash
# 设置环境变量（或在 .env 中配置）
export APP_USER="admin"
export APP_PASS="your_secure_password"

# 启动应用（会自动创建数据库和初始化）
python app.py
```

**首次启动时会自动完成**:
- ✅ 创建所有数据库表
- ✅ 创建默认部门"总公司"
- ✅ 创建管理员账户
- ✅ 初始化算法配置（3个预设方案：严格/标准/宽松）
- ✅ 插入初始化日志

看到以下输出表示初始化成功：
```
✅ 算法配置初始化完成: 已创建3个预设方案(严格/标准/宽松)，当前配置为'标准'档
 * Running on http://0.0.0.0:5001
```

### 6. 访问系统
打开浏览器访问: `http://localhost:5001`

使用您设置的管理员账户登录。

---

## 🔧 生产环境部署

### 方式1: 使用 Gunicorn (推荐 - Linux/macOS)

```bash
# 1. 安装 Gunicorn
pip install gunicorn

# 2. 启动应用（4个工作进程）
gunicorn -w 4 -b 0.0.0.0:5001 app:app

# 3. 后台运行
nohup gunicorn -w 4 -b 0.0.0.0:5001 app:app > logs/gunicorn.log 2>&1 &

# 4. 查看日志
tail -f logs/gunicorn.log
```

### 方式2: 使用 Waitress (推荐 - Windows)

```bash
# 1. 安装 Waitress
pip install waitress

# 2. 创建启动脚本 serve.py
```

创建 `serve.py`:
```python
from waitress import serve
from app import app

if __name__ == '__main__':
    print("🚀 启动班组管理系统 (Waitress)")
    print("   访问地址: http://localhost:5001")
    serve(app, host='0.0.0.0', port=5001, threads=4)
```

```bash
# 3. 运行
python serve.py
```

### 方式3: 使用 systemd 服务 (Linux)

创建 `/etc/systemd/system/team-management.service`:
```ini
[Unit]
Description=Team Management System
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/源码
Environment="PATH=/path/to/源码/.venv/bin"
EnvironmentFile=/path/to/源码/.env
ExecStart=/path/to/源码/.venv/bin/gunicorn -w 4 -b 0.0.0.0:5001 app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl start team-management
sudo systemctl enable team-management

# 查看状态
sudo systemctl status team-management

# 查看日志
sudo journalctl -u team-management -f
```

---

## 🔐 安全配置检查清单

### 必须配置项

- [ ] **修改 SECRET_KEY**: 使用随机生成的密钥
  ```bash
  python -c "import os; print(os.urandom(24).hex())"
  ```

- [ ] **设置强密码**: APP_PASS 必须使用强密码（建议12位以上，包含大小写字母、数字、特殊字符）

- [ ] **关闭调试模式**: 修改 `app.py` 最后一行
  ```python
  # 生产环境必须设置 debug=False
  app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5001)), debug=False)
  ```

- [ ] **文件权限**: 确保数据库和上传目录权限正确
  ```bash
  chmod 640 app.db
  chmod 755 uploads exports
  chmod 750 logs backups
  ```

### 推荐配置项

- [ ] **配置防火墙**: 只开放必要端口
- [ ] **使用HTTPS**: 配置Nginx反向代理和SSL证书
- [ ] **定期备份数据库**: 设置自动备份脚本
- [ ] **日志轮转**: 配置logrotate避免日志文件过大

---

## 🗄️ 数据库备份

### 手动备份
```bash
# 备份数据库
cp app.db backups/app.db.backup_$(date +%Y%m%d_%H%M%S)
```

### 自动备份脚本

创建 `backup.sh`:
```bash
#!/bin/bash
BACKUP_DIR="backups"
DB_FILE="app.db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/app.db.backup_$TIMESTAMP"

# 创建备份
cp $DB_FILE $BACKUP_FILE
echo "✅ 数据库已备份: $BACKUP_FILE"

# 只保留最近7天的备份
find $BACKUP_DIR -name "app.db.backup_*" -mtime +7 -delete
echo "✅ 已清理7天前的备份文件"
```

```bash
chmod +x backup.sh

# 添加到 crontab (每天凌晨2点备份)
crontab -e
0 2 * * * cd /path/to/源码 && ./backup.sh >> logs/backup.log 2>&1
```

---

## 📊 功能验证

部署完成后，请验证以下功能：

### 1. 登录功能
- [ ] 访问 `http://localhost:5001`
- [ ] 使用管理员账户登录
- [ ] 验证登录成功跳转到绩效管理页面

### 2. 核心功能
- [ ] **绩效管理**: 上传绩效数据Excel文件
- [ ] **人员画像**: 查看人员能力画像页面
- [ ] **算法配置**: 访问系统配置 → 算法配置页面，查看预设方案
- [ ] **培训管理**: 上传培训记录
- [ ] **安全管理**: 上传安全检查记录

### 3. 动态配置验证
- [ ] 打开人员画像页面
- [ ] 查看图例显示 "关键人员（综合分<70 或 月均违规≥3次）"
- [ ] 打开算法配置页面
- [ ] 查看"标准"预设方案，确认月均违规阈值显示为"≥3"

---

## 🔧 环境变量说明

| 变量名 | 必需 | 默认值 | 说明 |
|--------|------|--------|------|
| `APP_USER` | 是 | wang | 管理员用户名 |
| `APP_PASS` | 是 | wang@-1989 | 管理员密码（生产环境必须修改） |
| `SECRET_KEY` | 推荐 | 内置默认值 | Flask密钥（生产环境必须修改） |
| `PORT` | 否 | 5001 | 应用监听端口 |
| `DB_PATH` | 否 | app.db | 数据库文件路径 |
| `DEBUG` | 否 | False | 调试模式（生产环境必须为False） |

### 设置环境变量的方式

#### 方式1: 使用 .env 文件（推荐）
```bash
# 复制示例文件
cp .env.example .env

# 编辑 .env 文件
nano .env
```

#### 方式2: 导出环境变量
```bash
export APP_USER="admin"
export APP_PASS="your_password"
export SECRET_KEY="your_secret_key"
export PORT=5001
```

#### 方式3: 启动时指定
```bash
APP_USER=admin APP_PASS=your_password python app.py
```

---

## ❓ 常见问题

### Q1: 启动后看不到算法配置初始化消息
**A**: 检查数据库中是否已有预设方案。如果首次启动时 `algorithm_presets` 表为空，会自动初始化并输出消息。如果表中已有数据，不会重复初始化。

### Q2: 如何重置数据库？
**A**:
```bash
# 1. 停止应用
# 2. 删除数据库文件
rm app.db
# 3. 重新启动应用
python app.py
```

### Q3: 如何修改算法配置？
**A**: 登录系统后，访问"系统配置" → "算法配置"页面，可以：
- 切换预设方案（严格/标准/宽松）
- 查看详细的计算公式
- 查看当前配置参数

### Q4: 如何查看日志？
**A**:
```bash
# 查看应用日志
tail -f logs/app.log

# 查看 Gunicorn 日志
tail -f logs/gunicorn.log
```

### Q5: 忘记管理员密码怎么办？
**A**:
```bash
# 停止应用后，使用 Python 重置密码
python -c "
from werkzeug.security import generate_password_hash
import sqlite3
conn = sqlite3.connect('app.db')
cur = conn.cursor()
new_password = 'your_new_password'
cur.execute('UPDATE users SET password_hash = ? WHERE username = ?',
            (generate_password_hash(new_password), 'admin'))
conn.commit()
print('密码已重置')
"
```

---

## 📞 技术支持

如有问题，请检查：
1. 日志文件 (`logs/` 目录)
2. 数据库文件是否正常创建
3. 环境变量是否正确设置
4. Python 版本和依赖包是否正确安装

---

## 📝 更新日志

### v1.0 (2025-12-25)
- ✅ 集成算法配置表到 app.py
- ✅ 自动初始化3个预设方案（严格/标准/宽松）
- ✅ 当前配置默认为"标准"档
- ✅ 关键人员月均违规阈值: 3次
- ✅ 所有配置参数动态加载
