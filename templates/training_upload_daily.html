{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h5 class="mb-0">上传培训日报</h5>
    <small class="text-muted">支持批量上传 .xls 格式的培训日报文件</small>
  </div>
  <div class="btn-group">
    <a href="{{ url_for('training.upload') }}" class="btn btn-outline-secondary btn-sm">返回</a>
    <a href="{{ url_for('training.index') }}" class="btn btn-secondary btn-sm">培训工作台</a>
  </div>
</div>

<!-- 上传说明 -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-info text-white">
    <h6 class="mb-0"><i class="fas fa-info-circle"></i> 上传说明</h6>
  </div>
  <div class="card-body">
    <h6>支持的文件格式</h6>
    <ul>
      <li>仅支持 <code>.xls</code> 格式的培训日报文件</li>
      <li>支持一次选择多个文件批量上传</li>
    </ul>

    <h6 class="mt-3">文件要求</h6>
    <ul>
      <li><strong>第2行</strong>: 填报单位信息（如：客运二中心乘务一室2号线客车二队）</li>
      <li><strong>第3行</strong>: 培训日期信息</li>
      <li><strong>第5行</strong>: 数据表头（姓名、工号、故障、问题类型、具体问题等）</li>
      <li><strong>第6行起</strong>: 培训记录数据</li>
    </ul>

    <h6 class="mt-3">字段映射</h6>
    <div class="row">
      <div class="col-md-6">
        <ul>
          <li><strong>班组</strong>: 从填报单位自动提取</li>
          <li><strong>培训日期</strong>: 从日期行自动提取</li>
          <li><strong>项目类别</strong>: "故障"列</li>
          <li><strong>是否合格</strong>: 问题类型为"失格类"则不合格</li>
        </ul>
      </div>
      <div class="col-md-6">
        <ul>
          <li><strong>失格补做</strong>: 从备注栏自动识别</li>
          <li>备注中包含"失格"、"复检"或"补做"关键词</li>
          <li>自动关联到之前的失格记录</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- 上传表单 -->
<div class="card shadow-sm">
  <div class="card-header">
    <h6 class="mb-0">选择文件上传</h6>
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="files" class="form-label">选择培训日报文件（可多选）</label>
        <input type="file" id="files" name="files" class="form-control"
               accept=".xls" multiple required>
        <div class="form-text">
          按住 Ctrl (Windows) 或 Cmd (Mac) 可选择多个文件
        </div>
      </div>

      <div id="file-list" class="mb-3"></div>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-upload"></i> 开始导入
        </button>
        <a href="{{ url_for('training.upload') }}" class="btn btn-outline-secondary">
          取消
        </a>
      </div>
    </form>
  </div>
</div>

<script>
// 显示选中的文件列表
document.getElementById('files').addEventListener('change', function(e) {
  const fileList = document.getElementById('file-list');
  const files = e.target.files;

  if (files.length === 0) {
    fileList.innerHTML = '';
    return;
  }

  let html = '<div class="alert alert-info"><strong>已选择 ' + files.length + ' 个文件:</strong><ul class="mb-0 mt-2">';
  for (let i = 0; i < files.length; i++) {
    html += '<li>' + files[i].name + ' (' + (files[i].size / 1024).toFixed(2) + ' KB)</li>';
  }
  html += '</ul></div>';
  fileList.innerHTML = html;
});
</script>
{% endblock %}
