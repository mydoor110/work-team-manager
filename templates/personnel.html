{% extends "base.html" %}

{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between mb-4">
  <div>
    <h1 class="mb-1">人员管理</h1>
    <p class="text-muted mb-0">
      当前在册 {{ rows|length }} 人。所有绩效、培训、安全模块均引用此处档案信息。
    </p>
  </div>
  <div class="d-flex gap-2 mt-3 mt-lg-0 flex-wrap">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#personnelAddModal">新增人员</button>
    <form id="personnel-import-form" action="{{ url_for('personnel.import_data') }}" method="post" enctype="multipart/form-data" class="d-inline">
      <input type="file" id="personnel-import-input" class="d-none" name="file" accept=".xlsx">
      <button type="button" class="btn btn-outline-primary" id="personnel-import-trigger">导入 Excel</button>
    </form>
    <a class="btn btn-outline-secondary" href="{{ url_for('personnel.template') }}">下载模板</a>
  </div>
</div>

<div class="alert alert-info small py-2 px-3 mb-4" id="personnel-table-status">
  修改表格中的任意字段后将自动保存，计算字段会根据最新信息即时刷新。导入数据前可先下载模板，按照表头填写。
</div>


<div class="card shadow-sm mt-4" id="personnel-table-card">
  <div class="card-header bg-light d-flex flex-column flex-xl-row align-items-xl-center justify-content-xl-between">
    <span>人员一览（可直接编辑）</span>
    <div class="d-flex gap-2 align-items-center mt-2 mt-xl-0">
      <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display:none;">
        <i class="fas fa-trash me-1"></i>批量删除
      </button>
      <span class="text-muted small">横向滚动查看更多字段，点击"档案"可查看详细界面。</span>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle mb-0 personnel-table">
        <thead class="table-light">
          <tr>
            <th style="width:40px">
              <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll(this)">
            </th>
            {% for field in field_scheme %}
            <th scope="col">{{ field.label }}</th>
            {% endfor %}
            <th scope="col">年龄</th>
            <th scope="col">工龄 (年)</th>
            <th scope="col">司龄 (年)</th>
            <th scope="col">取证年限 (年)</th>
            <th scope="col">单独驾驶年限 (年)</th>
            <th scope="col">操作</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr data-emp-no="{{ row.emp_no }}" data-update-url="{{ url_for('personnel.update', emp_no=row.emp_no) }}">
            <td>
              <input type="checkbox" class="form-check-input personnel-checkbox" value="{{ row.emp_no }}" onchange="updateBatchDeleteBtn()">
            </td>
            {% for field in field_scheme %}
            {% set name = field.name %}
            {% set label = field.label %}
            {% set input_type = field.input_type %}
            {% set value = row[name] %}
            <td>
              {% if name == "emp_no" %}
              <input type="text" class="form-control form-control-sm" value="{{ row.emp_no }}" readonly>
              {% elif input_type == "department_select" %}
              <select class="form-select form-select-sm" data-field="{{ name }}" data-label="{{ label }}" {% if field.required %}required{% endif %}>
                <option value="">未分配</option>
                {% for dept in accessible_departments %}
                <option value="{{ dept.id }}" {% if value == dept.id %}selected{% endif %}>
                  {{ '　' * (dept.level - 1) }}{{ dept.name }}
                </option>
                {% endfor %}
              </select>
              {% elif input_type == "select" %}
              <select class="form-select form-select-sm" data-field="{{ name }}" data-label="{{ label }}">
                <option value="">未填写</option>
                {% for option in select_options.get(name, []) %}
                <option value="{{ option }}" {% if value == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
              {% elif input_type == "textarea" %}
              <textarea class="form-control form-control-sm" rows="1" data-field="{{ name }}" data-label="{{ label }}" placeholder="请输入{{ label }}">{{ value or "" }}</textarea>
              {% elif input_type == "date" %}
              <input type="date" class="form-control form-control-sm" data-field="{{ name }}" data-label="{{ label }}" value="{{ value or "" }}">
              {% else %}
              <input type="text" class="form-control form-control-sm" data-field="{{ name }}" data-label="{{ label }}" value="{{ value or "" }}" {% if field.required %}required{% endif %}>
              {% endif %}
            </td>
            {% endfor %}
            <td data-computed="age">{{ row.age if row.age is not none else "-" }}</td>
            <td data-computed="working_years">
              {% if row.working_years is not none %}
              {{ "%.1f"|format(row.working_years) }}
              {% else %}
              -
              {% endif %}
            </td>
            <td data-computed="tenure_years">
              {% if row.tenure_years is not none %}
              {{ "%.1f"|format(row.tenure_years) }}
              {% else %}
              -
              {% endif %}
            </td>
            <td data-computed="certification_years">
              {% if row.certification_years is not none %}
              {{ "%.1f"|format(row.certification_years) }}
              {% else %}
              -
              {% endif %}
            </td>
            <td data-computed="solo_driving_years">
              {% if row.solo_driving_years is not none %}
              {{ "%.1f"|format(row.solo_driving_years) }}
              {% else %}
              -
              {% endif %}
            </td>
            <td class="text-nowrap">
              <a class="btn btn-link btn-sm px-1" data-role="preview-link" href="{{ url_for('personnel.preview', emp_no=row.emp_no) }}">档案</a>
            </td>
          </tr>
          {% endfor %}
          {% if rows|length == 0 %}
          <tr>
            <td colspan="{{ field_scheme|length + 7 }}" class="text-center text-muted py-4">暂无人员，请先新增或导入。</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>


<script>
  (function () {
    const statusBox = document.getElementById("personnel-table-status");
    const table = document.querySelector(".personnel-table");
    const inputs = table ? Array.from(table.querySelectorAll("[data-field]")) : [];

    function setStatus(message, level = "info") {
      if (!statusBox) return;
      statusBox.textContent = message;
      statusBox.className = "alert alert-" + level + " small py-2 px-3 mb-4";
    }

    function formatYears(value) {
      if (value === null || value === undefined || value === "") {
        return "-";
      }
      const num = typeof value === "number" ? value : parseFloat(value);
      if (Number.isNaN(num)) {
        return "-";
      }
      return num.toFixed(1);
    }

    function updateRowComputed(row, person) {
      const ageCell = row.querySelector("[data-computed='age']");
      if (ageCell) {
        ageCell.textContent = (person.age === null || person.age === undefined) ? "-" : person.age;
      }
      const workCell = row.querySelector("[data-computed='working_years']");
      if (workCell) {
        workCell.textContent = formatYears(person.working_years);
      }
      const tenureCell = row.querySelector("[data-computed='tenure_years']");
      if (tenureCell) {
        tenureCell.textContent = formatYears(person.tenure_years);
      }
      const certCell = row.querySelector("[data-computed='certification_years']");
      if (certCell) {
        certCell.textContent = formatYears(person.certification_years);
      }
      const soloCell = row.querySelector("[data-computed='solo_driving_years']");
      if (soloCell) {
        soloCell.textContent = formatYears(person.solo_driving_years);
      }
    }

    function handleUpdate(input) {
      const row = input.closest("tr");
      if (!row) return;
      const updateUrl = row.dataset.updateUrl;
      if (!updateUrl) return;
      const field = input.dataset.field;
      const label = input.dataset.label || field;
      const value = input.value;

      setStatus("正在保存 “" + label + "” ...", "info");
      input.classList.remove("is-invalid");

      fetch(updateUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ field, value })
      })
        .then((res) => res.json().then((body) => ({ ok: res.ok, body })))
        .then(({ ok, body }) => {
          if (!ok || !body.ok) {
            throw new Error(body.message || "保存失败");
          }
          const person = body.person || {};
          const newValue = person[field];
          if (input.tagName === "SELECT") {
            input.value = newValue || "";
          } else if (input.type === "date") {
            input.value = newValue || "";
          } else {
            input.value = newValue || "";
          }
          updateRowComputed(row, person);
          const previewLink = row.querySelector("[data-role='preview-link']");
          if (previewLink && person.emp_no) {
            previewLink.href = previewLink.href.replace(/personnel\/[^/]+/, "personnel/" + person.emp_no);
          }
          const deleteBtn = row.querySelector("[data-role='delete-button']");
          if (deleteBtn) {
            const nameForConfirm = (person.name || "").replace(/'/g, "\\'");
            deleteBtn.setAttribute("onclick", "return confirm('确定删除 " + nameForConfirm + " 的档案吗？此操作不可撤销。');");
          }
          setStatus("已保存 “" + label + "”。", "success");
        })
        .catch((err) => {
          setStatus(err.message || "保存失败，请稍后再试。", "danger");
          input.classList.add("is-invalid");
        });
    }

    inputs.forEach((input) => {
      const eventName = input.tagName === "TEXTAREA" ? "blur" : "change";
      input.addEventListener(eventName, () => handleUpdate(input));
    });

    const importForm = document.getElementById("personnel-import-form");
    const importInput = document.getElementById("personnel-import-input");
    const importTrigger = document.getElementById("personnel-import-trigger");
    if (importTrigger && importInput && importForm) {
      importTrigger.addEventListener("click", () => importInput.click());
      importInput.addEventListener("change", () => {
        if (importInput.files.length > 0) {
          importForm.submit();
        }
      });
    }
  })();

  // 批量删除相关函数
  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.personnel-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = checkbox.checked;
    });
    updateBatchDeleteBtn();
  }

  function updateBatchDeleteBtn() {
    const checkboxes = document.querySelectorAll('.personnel-checkbox:checked');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (checkboxes.length > 0) {
      batchDeleteBtn.style.display = 'inline-block';
      batchDeleteBtn.innerHTML = `<i class="fas fa-trash me-1"></i>批量删除 (${checkboxes.length})`;
    } else {
      batchDeleteBtn.style.display = 'none';
    }

    // 更新全选复选框状态
    const allCheckboxes = document.querySelectorAll('.personnel-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    }
  }

  function batchDelete() {
    const checkboxes = document.querySelectorAll('.personnel-checkbox:checked');
    if (checkboxes.length === 0) {
      alert('请至少选择一名员工');
      return;
    }

    const empNos = Array.from(checkboxes).map(cb => cb.value);
    if (confirm(`确定要删除选中的 ${empNos.length} 名员工吗？此操作不可恢复！`)) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = "{{ url_for('personnel.batch_delete') }}";

      // Add CSRF token
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrf_token';
      csrfInput.value = '{{ csrf_token() }}';
      form.appendChild(csrfInput);

      empNos.forEach(empNo => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'emp_nos';
        input.value = empNo;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    }
  }
</script>

<div class="modal fade" id="personnelAddModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <form class="modal-content" method="post">
      <div class="modal-header">
        <h5 class="modal-title">新增人员</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          {% for field in field_scheme %}
          {% set name = field.name %}
          {% set label = field.label %}
          {% set input_type = field.input_type %}
          {% set required = field.required %}
          <div class="col-12 col-md-6">
            <label class="form-label">
              {{ label }}
              {% if required %}
              <span class="text-danger">*</span>
              {% endif %}
            </label>
            {% if input_type == "department_select" %}
            <select class="form-select" name="{{ name }}" {% if required %}required{% endif %}>
              <option value="">未分配</option>
              {% for dept in accessible_departments %}
              <option value="{{ dept.id }}">
                {{ '　' * (dept.level - 1) }}{{ dept.name }}
              </option>
              {% endfor %}
            </select>
            {% elif input_type == "textarea" %}
            <textarea class="form-control" name="{{ name }}" rows="3" placeholder="请输入{{ label }}"></textarea>
            {% elif input_type == "select" %}
            <select class="form-select" name="{{ name }}">
              <option value="">未填写</option>
              {% for option in select_options.get(name, []) %}
              <option value="{{ option }}">{{ option }}</option>
              {% endfor %}
            </select>
            {% elif input_type == "date" %}
            <input type="date" class="form-control" name="{{ name }}">
            {% else %}
            <input type="text" class="form-control" name="{{ name }}" {% if required %}required{% endif %}>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div class="alert alert-info mt-3 mb-0">
          出生年月、参加工作时间、入司时间填写后，页面会自动计算年龄、工龄和司龄；Excel 导入同样支持自动计算。
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
