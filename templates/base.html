<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <title>{{ title or "绩效汇总 · 简易版" }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('performance.index') }}">绩效汇总 · 简易版</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切换导航">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNav">
          {% if session.get("logged_in") %}
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'performance.index' %}active{% endif %}" href="{{ url_for('performance.index') }}">绩效</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'training.index' %}active{% endif %}" href="{{ url_for('training.index') }}">培训</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'safety.index' %}active{% endif %}" href="{{ url_for('safety.index') }}">安全管理</a>
            </li>
            <li class="nav-item">
              {% set personnel_active = request.endpoint and request.endpoint.startswith('personnel.') %}
              <a class="nav-link {% if personnel_active %}active{% endif %}" href="{{ url_for('personnel.dashboard') }}">人员管理</a>
            </li>
            {% if session.get("user_id") == 1 %}
            <li class="nav-item dropdown">
              {% set admin_endpoints = ["admin_users", "departments", "department_detail", "backup_management"] %}
              <a class="nav-link dropdown-toggle {% if request.endpoint in admin_endpoints %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                系统管理
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="{{ url_for('admin.users') }}">用户管理</a></li>
                <li><a class="dropdown-item" href="{{ url_for('departments.index') }}">部门管理</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('admin.import_logs') }}"><i class="fas fa-file-import me-1"></i>导入日志审查</a></li>
                <li><a class="dropdown-item" href="{{ url_for('system_config.algorithm_config_page') }}">算法参数配置</a></li>
                <li><a class="dropdown-item" href="{{ url_for('admin.backups') }}"><i class="fas fa-database me-1"></i>备份管理</a></li>
              </ul>
            </li>
            {% endif %}
          </ul>
          <div class="d-flex flex-column flex-lg-row align-items-lg-center ms-lg-auto">
            {% if session.get("username") %}
            <span class="navbar-text text-white-50 me-lg-3 mb-2 mb-lg-0">你好，{{ session['username'] }}</span>
            {% endif %}
            <div class="d-flex flex-column flex-lg-row">
              <a class="btn btn-outline-secondary btn-sm mb-2 mb-lg-0 me-lg-2" href="{{ url_for('auth.change_password') }}">修改密码</a>
              <a class="btn btn-outline-light btn-sm" href="{{ url_for('auth.logout') }}">退出</a>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </nav>
    <div class="container py-4">
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ msg }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ========== 响应式优化脚本 ==========

      // 添加触摸滚动提示
      document.addEventListener('DOMContentLoaded', function() {
        const tableContainers = document.querySelectorAll('.table-responsive');

        tableContainers.forEach(container => {
          // 检测是否可以滚动
          function checkScroll() {
            if (container.scrollWidth > container.clientWidth) {
              container.classList.add('has-scroll');
              // 添加滚动提示
              if (!container.querySelector('.scroll-hint')) {
                const hint = document.createElement('div');
                hint.className = 'scroll-hint';
                hint.style.cssText = 'position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; pointer-events: none; opacity: 0; transition: opacity 0.3s;';
                hint.textContent = '← 滑动查看更多 →';
                container.style.position = 'relative';
                container.appendChild(hint);

                // 3秒后隐藏提示
                setTimeout(() => {
                  hint.style.opacity = '1';
                  setTimeout(() => {
                    hint.style.opacity = '0';
                    setTimeout(() => hint.remove(), 300);
                  }, 2000);
                }, 500);
              }
            }
          }

          checkScroll();
          window.addEventListener('resize', checkScroll);
        });

        // 移动端表格触摸优化
        if ('ontouchstart' in window) {
          tableContainers.forEach(container => {
            let isScrolling = false;

            container.addEventListener('touchstart', () => {
              isScrolling = true;
            });

            container.addEventListener('touchend', () => {
              setTimeout(() => {
                isScrolling = false;
              }, 100);
            });
          });
        }
      });

      // CSRF protection for AJAX requests
      window.csrf_token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

      // Add CSRF token to all AJAX requests
      if (window.csrf_token) {
        // For jQuery AJAX (if used)
        if (typeof $ !== 'undefined') {
          $.ajaxSetup({
            beforeSend: function(xhr, settings) {
              if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", window.csrf_token);
              }
            }
          });
        }

        // For fetch API
        const originalFetch = window.fetch;
        window.fetch = function(input, init) {
          init = init || {};
          if (init.method && !/^(GET|HEAD|OPTIONS|TRACE)$/i.test(init.method)) {
            init.headers = init.headers || {};
            if (typeof init.headers.set === 'function') {
              init.headers.set('X-CSRFToken', window.csrf_token);
            } else {
              init.headers['X-CSRFToken'] = window.csrf_token;
            }
          }
          return originalFetch.apply(this, arguments);
        };
      }

      // Add hidden CSRF input to all forms
      document.addEventListener('DOMContentLoaded', function() {
        if (window.csrf_token) {
          const forms = document.querySelectorAll('form[method="post"], form[method="POST"]');
          forms.forEach(function(form) {
            // Check if CSRF token already exists
            if (!form.querySelector('input[name="csrf_token"]')) {
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = 'csrf_token';
              csrfInput.value = window.csrf_token;
              form.appendChild(csrfInput);
            }
          });
        }
      });
    </script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
