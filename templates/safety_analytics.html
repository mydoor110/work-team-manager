{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
<style>
  .chart-container {
    height: 400px;
    width: 100%;
  }
  .stat-card {
    transition: transform 0.2s;
  }
  .stat-card:hover {
    transform: translateY(-5px);
  }
  .large-number {
    font-size: 3rem;
    font-weight: bold;
    color: #0d6efd;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
  <h1 class="mb-2">安全统计分析 <span id="pageDateRange" class="badge bg-primary" style="font-size: 0.5em; vertical-align: middle;"></span></h1>
  <p class="text-muted">可视化展示安全检查数据，支持时间范围筛选和多维度分析。</p>
</div>

<!-- 筛选器 -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form class="row g-3" id="filterForm">
      <div class="col-md-3">
        <label class="form-label">开始日期</label>
        <input type="date" class="form-control" id="start_date" name="start_date">
      </div>
      <div class="col-md-3">
        <label class="form-label">结束日期</label>
        <input type="date" class="form-control" id="end_date" name="end_date">
      </div>
      <div class="col-md-2">
        <label class="form-label">类别</label>
        <select class="form-select" id="category" name="category">
          <option value="">全部</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">责任车队</label>
        <select class="form-select" id="team" name="team">
          <option value="">全部</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-primary w-100" onclick="loadData()">
          <i class="bi bi-bar-chart me-1"></i>刷新分析
        </button>
      </div>
    </form>
  </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body text-center">
        <h6 class="text-muted mb-3">事件总数</h6>
        <div class="large-number" id="totalCount">0</div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body text-center">
        <h6 class="text-muted mb-3">已整改</h6>
        <div class="large-number text-success" id="rectifiedCount">0</div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body text-center">
        <h6 class="text-muted mb-3">未整改</h6>
        <div class="large-number text-warning" id="unrectifiedCount">0</div>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body text-center">
        <h6 class="text-muted mb-3">整改率</h6>
        <div class="large-number text-info" id="rectificationRate">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- 图表展示 -->
<div class="row">
  <!-- 类别分布饼图 -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0">事件类型分布</h6>
      </div>
      <div class="card-body">
        <div id="categoryChart" class="chart-container"></div>
      </div>
    </div>
  </div>

  <!-- 按日期统计柱状图 -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0">每日事件统计</h6>
      </div>
      <div class="card-body">
        <div id="dailyChart" class="chart-container"></div>
      </div>
    </div>
  </div>

  <!-- 地点统计柱状图 -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0">检查地点分布</h6>
      </div>
      <div class="card-body">
        <div id="locationChart" class="chart-container"></div>
      </div>
    </div>
  </div>

  <!-- 责任车队统计 -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0">责任车队统计</h6>
      </div>
      <div class="card-body">
        <div id="teamChart" class="chart-container"></div>
      </div>
    </div>
  </div>

  <!-- 整改情况词云 -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0">整改措施词云</h6>
      </div>
      <div class="card-body">
        <div id="wordCloudChart" class="chart-container"></div>
      </div>
    </div>
  </div>

  <!-- 考核情况统计 -->
  <div class="col-lg-6 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0">考核情况统计</h6>
      </div>
      <div class="card-body">
        <div id="assessmentChart" class="chart-container"></div>
      </div>
    </div>
  </div>
</div>

<script>
let allData = [];
let charts = {};

// 初始化图表
function initCharts() {
  charts.category = echarts.init(document.getElementById('categoryChart'));
  charts.daily = echarts.init(document.getElementById('dailyChart'));
  charts.location = echarts.init(document.getElementById('locationChart'));
  charts.team = echarts.init(document.getElementById('teamChart'));
  charts.wordCloud = echarts.init(document.getElementById('wordCloudChart'));
  charts.assessment = echarts.init(document.getElementById('assessmentChart'));

  // 响应式调整
  window.addEventListener('resize', () => {
    Object.values(charts).forEach(chart => chart.resize());
  });
}

// 更新页面日期范围显示
function updatePageDateRange() {
  const startDate = document.getElementById('start_date')?.value;
  const endDate = document.getElementById('end_date')?.value;
  const dateRangeEl = document.getElementById('pageDateRange');

  if (!dateRangeEl) return;

  if (startDate || endDate) {
    const start = startDate || '起始';
    const end = endDate || '当前';
    dateRangeEl.textContent = `${start} 至 ${end}`;
    dateRangeEl.style.display = 'inline-block';
  } else {
    dateRangeEl.textContent = '全部数据';
    dateRangeEl.style.display = 'inline-block';
  }
}

// 加载数据
async function loadData() {
  const formData = new FormData(document.getElementById('filterForm'));
  const params = new URLSearchParams(formData);

  // 更新页面日期范围显示
  updatePageDateRange();

  try {
    const response = await fetch(`{{ url_for('safety.api_data') }}?${params}`);
    allData = await response.json();

    // 填充筛选器选项
    populateFilters();

    // 更新所有图表
    updateStatCards();
    updateCategoryChart();
    updateDailyChart();
    updateLocationChart();
    updateTeamChart();
    updateWordCloud();
    updateAssessmentChart();
  } catch (error) {
    console.error('加载数据失败:', error);
  }
}

// 填充筛选器选项
function populateFilters() {
  const categories = new Set();
  const teams = new Set();

  allData.forEach(record => {
    if (record.category) categories.add(record.category);
    if (record.responsible_team) teams.add(record.responsible_team);
  });

  const categorySelect = document.getElementById('category');
  const teamSelect = document.getElementById('team');

  // 保留当前选中值
  const currentCategory = categorySelect.value;
  const currentTeam = teamSelect.value;

  // 更新类别选项
  categorySelect.innerHTML = '<option value="">全部</option>';
  Array.from(categories).sort().forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    if (cat === currentCategory) option.selected = true;
    categorySelect.appendChild(option);
  });

  // 更新车队选项
  teamSelect.innerHTML = '<option value="">全部</option>';
  Array.from(teams).sort().forEach(team => {
    const option = document.createElement('option');
    option.value = team;
    option.textContent = team;
    if (team === currentTeam) option.selected = true;
    teamSelect.appendChild(option);
  });
}

// 更新统计卡片
function updateStatCards() {
  const total = allData.length;
  const rectified = allData.filter(r => r.rectification_status && r.rectification_status.includes('已整改')).length;
  const unrectified = total - rectified;
  const rate = total > 0 ? ((rectified / total) * 100).toFixed(1) : 0;

  document.getElementById('totalCount').textContent = total;
  document.getElementById('rectifiedCount').textContent = rectified;
  document.getElementById('unrectifiedCount').textContent = unrectified;
  document.getElementById('rectificationRate').textContent = rate + '%';
}

// 类别分布饼图
function updateCategoryChart() {
  const categoryData = {};
  allData.forEach(record => {
    const cat = record.category || '未分类';
    categoryData[cat] = (categoryData[cat] || 0) + 1;
  });

  const data = Object.entries(categoryData).map(([name, value]) => ({ name, value }));

  charts.category.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      right: 10,
      top: 'center',
      data: data.map(item => item.name)
    },
    series: [{
      type: 'pie',
      radius: ['40%', '70%'],
      avoidLabelOverlap: false,
      itemStyle: {
        borderRadius: 10,
        borderColor: '#fff',
        borderWidth: 2
      },
      label: {
        show: false,
        position: 'center'
      },
      emphasis: {
        label: {
          show: true,
          fontSize: 20,
          fontWeight: 'bold'
        }
      },
      labelLine: {
        show: false
      },
      data: data
    }]
  });
}

// 每日统计柱状图
function updateDailyChart() {
  const dailyData = {};
  allData.forEach(record => {
    const date = record.inspection_date;
    dailyData[date] = (dailyData[date] || 0) + 1;
  });

  const sortedDates = Object.keys(dailyData).sort();
  const values = sortedDates.map(date => dailyData[date]);

  charts.daily.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: sortedDates,
      axisLabel: {
        rotate: 45,
        interval: Math.floor(sortedDates.length / 10) || 0
      }
    },
    yAxis: {
      type: 'value'
    },
    series: [{
      name: '事件数',
      type: 'bar',
      data: values,
      itemStyle: {
        color: '#5470c6'
      }
    }]
  });
}

// 地点统计柱状图
function updateLocationChart() {
  const locationData = {};
  allData.forEach(record => {
    const loc = record.location || '未知';
    locationData[loc] = (locationData[loc] || 0) + 1;
  });

  const sortedData = Object.entries(locationData)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 15);

  charts.location.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'value'
    },
    yAxis: {
      type: 'category',
      data: sortedData.map(([name]) => name)
    },
    series: [{
      name: '事件数',
      type: 'bar',
      data: sortedData.map(([, value]) => value),
      itemStyle: {
        color: '#91cc75'
      }
    }]
  });
}

// 责任车队统计
function updateTeamChart() {
  const teamData = {};
  allData.forEach(record => {
    const team = record.responsible_team || '未知';
    teamData[team] = (teamData[team] || 0) + 1;
  });

  const data = Object.entries(teamData).map(([name, value]) => ({ name, value }));

  charts.team.setOption({
    tooltip: {
      trigger: 'item'
    },
    series: [{
      type: 'pie',
      radius: '70%',
      data: data,
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }]
  });
}

// 整改措施词云
function updateWordCloud() {
  const words = {};
  allData.forEach(record => {
    const text = record.rectification_status || '';
    // 简单分词（按逗号、句号等分割）
    const segments = text.split(/[，。、；！？\s]+/);
    segments.forEach(word => {
      if (word.length >= 2) {
        words[word] = (words[word] || 0) + 1;
      }
    });
  });

  const data = Object.entries(words)
    .map(([name, value]) => ({ name, value }))
    .sort((a, b) => b.value - a.value)
    .slice(0, 100);

  charts.wordCloud.setOption({
    tooltip: {
      show: true
    },
    series: [{
      type: 'wordCloud',
      shape: 'circle',
      left: 'center',
      top: 'center',
      width: '90%',
      height: '90%',
      right: null,
      bottom: null,
      sizeRange: [12, 60],
      rotationRange: [-90, 90],
      rotationStep: 45,
      gridSize: 8,
      drawOutOfBound: false,
      layoutAnimation: true,
      textStyle: {
        fontFamily: 'sans-serif',
        fontWeight: 'bold',
        color: function () {
          return 'rgb(' + [
            Math.round(Math.random() * 160),
            Math.round(Math.random() * 160),
            Math.round(Math.random() * 160)
          ].join(',') + ')';
        }
      },
      emphasis: {
        focus: 'self',
        textStyle: {
          textShadowBlur: 10,
          textShadowColor: '#333'
        }
      },
      data: data
    }]
  });
}

// 考核情况统计
function updateAssessmentChart() {
  const assessmentData = {};
  allData.forEach(record => {
    const assessment = record.assessment || '未知';
    // 截取前30个字符作为显示
    const shortAssessment = assessment.length > 30 ? assessment.substring(0, 30) + '...' : assessment;
    assessmentData[shortAssessment] = (assessmentData[shortAssessment] || 0) + 1;
  });

  const sortedData = Object.entries(assessmentData)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  charts.assessment.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'value'
    },
    yAxis: {
      type: 'category',
      data: sortedData.map(([name]) => name),
      axisLabel: {
        interval: 0,
        formatter: function(value) {
          return value.length > 20 ? value.substring(0, 20) + '...' : value;
        }
      }
    },
    series: [{
      name: '次数',
      type: 'bar',
      data: sortedData.map(([, value]) => value),
      itemStyle: {
        color: '#fac858'
      }
    }]
  });
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  loadData();
});
</script>
{% endblock %}
