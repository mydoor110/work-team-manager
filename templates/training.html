{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h5 class="mb-0">培训统计分析</h5>
    <small class="text-muted">可视化分析培训数据和问题趋势</small>
  </div>
  <div class="btn-group">
    <a href="{{ url_for('training.index') }}" class="btn btn-outline-secondary btn-sm">返回工作台</a>
    <a href="{{ url_for('training.records') }}" class="btn btn-secondary btn-sm">查看记录</a>
  </div>
</div>

<!-- 筛选区域 -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label for="nameFilter" class="form-label">姓名</label>
        <input type="text" id="nameFilter" class="form-control form-control-sm">
      </div>
      {% set col_class = 'col-md-3' %}
      {% set show_quick_buttons = true %}
      {% set show_range_label = false %}
      {% include 'components/date_filter.html' %}
      <div class="col-md-2">
        <label for="disqualifiedFilter" class="form-label">是否失格</label>
        <select id="disqualifiedFilter" class="form-select form-select-sm">
          <option value="">全部</option>
          <option value="1">是 (失格)</option>
          <option value="0">否 (合格)</option>
        </select>
      </div>
      <div class="col-md-1">
        <button id="filterBtn" class="btn btn-sm btn-secondary w-100">查询</button>
      </div>
    </div>
  </div>
</div>

<!-- KPI 卡片 -->
<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h6 class="card-subtitle mb-2 text-muted">筛选区间内总人次</h6>
        <p class="card-text fs-1 fw-bold" id="kpi-total-count">0</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h6 class="card-subtitle mb-2 text-muted">筛选区间内失格人次</h6>
        <p class="card-text fs-1 fw-bold text-danger" id="kpi-disqualified-count">0</p>
      </div>
    </div>
  </div>
</div>

<!-- ECharts 图表容器 -->
<div class="row g-4 mb-4">
  <div class="col-xl-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div id="personCountChart" style="width: 100%; height: 500px;"></div>
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div id="problemTypeChart" style="width: 100%; height: 500px;"></div>
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div id="projectDisqualifiedChart" style="width: 100%; height: 600px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- New Row for Word Cloud and Team Rank -->
<div class="row g-4 mb-4">
  <div class="col-xl-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div id="wordCloudChart" style="width: 100%; height: 400px;"></div>
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title text-center mb-3">实操人次排名</h6>
        <div id="teamRankList">
          <!-- Ranking will be generated by JS -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 引入 ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>

<!-- 引入日期筛选器库 -->
<script src="{{ url_for('static', filename='js/date-filter.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // 初始化日期筛选器
  const dateFilter = new DateFilterHelper({
    defaultRange: 'current_month',
    onDateChange: fetchAndRenderChart,
    showQuickButtons: true,
    validateDates: true
  });

  const personCountChart = echarts.init(document.getElementById('personCountChart'));
  const problemTypeChart = echarts.init(document.getElementById('problemTypeChart'));
  const projectDisqualifiedChart = echarts.init(document.getElementById('projectDisqualifiedChart'));
  const wordCloudChart = echarts.init(document.getElementById('wordCloudChart'));

  function fetchAndRenderChart() {
    const name = document.getElementById('nameFilter').value;
    const disqualified = document.getElementById('disqualifiedFilter').value;

    // 获取日期参数
    const dateParams = dateFilter.getParams();

    const params = new URLSearchParams();
    if (name) params.append('name', name);
    if (dateParams.start_date) params.append('start_date', dateParams.start_date);
    if (dateParams.end_date) params.append('end_date', dateParams.end_date);
    if (disqualified) params.append('disqualified', disqualified);

    const apiUrl = `{{ url_for('training.api_data') }}?${params.toString()}`;

    [personCountChart, problemTypeChart, projectDisqualifiedChart, wordCloudChart].forEach(chart => chart.showLoading());

    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        [personCountChart, problemTypeChart, projectDisqualifiedChart, wordCloudChart].forEach(chart => chart.hideLoading());

        updateKpis(data);
        renderPersonCountChart(data);
        renderProblemTypeChart(data);
        renderProjectDisqualifiedChart(data);
        renderWordCloudChart(data);
        renderTeamRank(data);
      })
      .catch(error => {
        [personCountChart, problemTypeChart, projectDisqualifiedChart, wordCloudChart].forEach(chart => {
          try { chart.hideLoading(); } catch(e) {}
        });
        console.error('Error fetching chart data:', error);
      });
  }

  function updateKpis(data) {
    document.getElementById('kpi-total-count').textContent = data.length;
    const disqualifiedCount = data.filter(r => r.is_disqualified === 1).length;
    document.getElementById('kpi-disqualified-count').textContent = disqualifiedCount;
  }

  function renderPersonCountChart(data) {
    const personCount = {};
    data.forEach(record => {
      personCount[record.name] = (personCount[record.name] || 0) + 1;
    });
    const sortedData = Object.entries(personCount).sort((a, b) => b[1] - a[1]);
    const names = sortedData.map(item => item[0]);
    const counts = sortedData.map(item => item[1]);

    const option = {
      title: { text: '人员实操次数统计', left: 'center' },
      tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
      grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
      xAxis: { type: 'category', data: names, axisLabel: { interval: 0, rotate: 30 } },
      yAxis: { type: 'value', name: '次数' },
      series: [{
        name: '实操次数', type: 'bar', data: counts, barWidth: '60%',
        label: { show: true, position: 'top' }
      }],
      dataZoom: [{ type: 'inside' }, { type: 'slider' }]
    };
    personCountChart.setOption(option);
  }

  function renderProblemTypeChart(data) {
    const disqualifiedData = data.filter(r => r.is_disqualified === 1);
    const problemCount = {};
    disqualifiedData.forEach(record => {
      const type = record.problem_type || '未分类';
      problemCount[type] = (problemCount[type] || 0) + 1;
    });
    const chartData = Object.entries(problemCount).map(([name, value]) => ({ name, value }));

    const option = {
      title: { text: '问题类型分布', left: 'center' },
      tooltip: { trigger: 'item', formatter: '{a} <br/>{b} : {c} ({d}%)' },
      legend: { orient: 'vertical', left: 'left', top: '10%' },
      series: [{
        name: '问题类型',
        type: 'pie',
        radius: '65%',
        center: ['50%', '60%'],
        data: chartData,
        emphasis: {
          itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
        }
      }]
    };
    problemTypeChart.setOption(option);
  }

  function renderProjectDisqualifiedChart(data) {
    const disqualifiedData = data.filter(r => r.is_disqualified === 1);
    const projectCount = {};
    disqualifiedData.forEach(record => {
      const project = record.project_category || '未分类';
      projectCount[project] = (projectCount[project] || 0) + 1;
    });
    const sortedData = Object.entries(projectCount).sort((a, b) => a[1] - b[1]);
    const projects = sortedData.map(item => item[0]);
    const counts = sortedData.map(item => item[1]);

    const option = {
      title: { text: '各个实操项目失格次数统计', left: 'center' },
      tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
      grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
      xAxis: { type: 'value', boundaryGap: [0, 0.01] },
      yAxis: { type: 'category', data: projects },
      series: [{
        name: '失格次数',
        type: 'bar',
        data: counts,
        label: { show: true, position: 'right' }
      }]
    };
    projectDisqualifiedChart.setOption(option);
  }

  function renderWordCloudChart(data) {
    const disqualifiedData = data.filter(r => r.is_disqualified === 1 && r.specific_problem && r.specific_problem.trim() !== '无');
    const text = disqualifiedData.map(r => r.specific_problem).join(' ');

    const wordCounts = {};
    const words = text.split(/[;；,，.。\s\d+\.、]+/g);

    words.forEach(word => {
        const w = word.trim();
        if (w && w.length > 1 && !['的', '了', '未', '或', '和', '与'].includes(w)) {
            wordCounts[w] = (wordCounts[w] || 0) + 1;
        }
    });

    const chartData = Object.entries(wordCounts).map(([name, value]) => ({ name, value }));

    const option = {
        title: {
            text: '具体实操问题词云图',
            left: 'center'
        },
        tooltip: { show: true },
        series: [{
            type: 'wordCloud',
            shape: 'circle',
            left: 'center',
            top: 'center',
            width: '90%',
            height: '90%',
            sizeRange: [12, 50],
            rotationRange: [-90, 90],
            rotationStep: 45,
            gridSize: 8,
            drawOutOfBound: false,
            textStyle: {
                color: function () {
                    return 'rgb(' + [
                        Math.round(Math.random() * 160),
                        Math.round(Math.random() * 160),
                        Math.round(Math.random() * 160)
                    ].join(',') + ')';
                }
            },
            emphasis: {
                focus: 'self',
                textStyle: { shadowBlur: 10, shadowColor: '#333' }
            },
            data: chartData
        }]
    };
    wordCloudChart.setOption(option);
  }

  function renderTeamRank(data) {
    const rankListEl = document.getElementById('teamRankList');
    if (!rankListEl) return;

    const teamCounts = {};
    data.forEach(record => {
        const team = record.class_name || '未分配班组';
        teamCounts[team] = (teamCounts[team] || 0) + 1;
    });

    const sortedTeams = Object.entries(teamCounts).sort((a, b) => b[1] - a[1]);

    if (sortedTeams.length === 0) {
        rankListEl.innerHTML = '<p class="text-muted text-center mt-4">无班组数据</p>';
        return;
    }

    const maxCount = sortedTeams.length > 0 ? sortedTeams[0][1] : 0;

    const rankHtml = sortedTeams.map(([name, count], index) => {
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        let rankBadge = '';
        if (index === 0) {
            rankBadge = '<span class="badge rounded-pill bg-warning text-dark">1</span>';
        } else if (index === 1) {
            rankBadge = '<span class="badge rounded-pill bg-secondary">2</span>';
        } else if (index === 2) {
            rankBadge = '<span class="badge rounded-pill" style="background-color: #cd7f32; color: white;">3</span>';
        } else {
            rankBadge = `<span class="badge rounded-pill bg-light text-dark">${index + 1}</span>`;
        }

        return `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1 small">
                    <div>${rankBadge} <span class="ms-2">${name}</span></div>
                    <div class="fw-bold">${count}</div>
                </div>
                <div class="progress" style="height: 6px;"><div class="progress-bar" role="progressbar" style="width: ${percentage}%;"></div></div>
            </div>`;
    }).join('');

    rankListEl.innerHTML = rankHtml;
  }

  // 页面加载时和点击按钮时执行
  fetchAndRenderChart();
  document.getElementById('filterBtn').addEventListener('click', fetchAndRenderChart);

  // 监听窗口大小变化，重绘图表
  window.addEventListener('resize', function() {
    personCountChart.resize();
    problemTypeChart.resize();
    projectDisqualifiedChart.resize();
    wordCloudChart.resize();
  });
});
</script>
{% endblock %}