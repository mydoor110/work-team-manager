{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>ç®—æ³•å‚æ•°é…ç½®</h2>
            <p class="text-muted">é…ç½®äººç‰©ç”»åƒç®—æ³•çš„æƒ©ç½šåŠ›åº¦å‚æ•°ï¼ˆä»…ç³»ç»Ÿç®¡ç†å‘˜å¯é…ç½®ï¼‰</p>
            <hr>
        </div>
    </div>

    <!-- å½“å‰é…ç½®ä¿¡æ¯ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">å½“å‰é…ç½®</h5>
                    <div id="current-config-info">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿé…ç½®ï¼šé¢„è®¾æ–¹æ¡ˆ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">å¿«é€Ÿé…ç½®ï¼ˆé¢„è®¾æ–¹æ¡ˆï¼‰</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">é€‰æ‹©é¢„è®¾çš„æƒ©ç½šåŠ›åº¦æ–¹æ¡ˆï¼Œå¿«é€Ÿåº”ç”¨åˆ°ç³»ç»Ÿ</p>

                    <div class="row g-3" id="preset-options">
                        <!-- é¢„è®¾æ–¹æ¡ˆé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>

                    <hr class="my-4">

                    <div class="mb-3">
                        <label for="preset-reason" class="form-label">å˜æ›´åŸå› ï¼š<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="preset-reason" placeholder="è¯·è¾“å…¥å˜æ›´åŸå› ï¼ˆå¿…å¡«ï¼‰" required>
                    </div>

                    <button type="button" class="btn btn-primary" id="apply-preset-btn">
                        <i class="bi bi-check-circle"></i> åº”ç”¨é€‰ä¸­çš„é¢„è®¾æ–¹æ¡ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é«˜çº§è‡ªå®šä¹‰ï¼ˆæŠ˜å é¢æ¿ï¼‰ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#advanced-config">
                    <h5 class="mb-0">
                        <i class="bi bi-chevron-down"></i> é«˜çº§è‡ªå®šä¹‰
                        <small class="text-muted">ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</small>
                    </h5>
                </div>
                <div id="advanced-config" class="collapse">
                    <div class="card-body">
                        <p class="text-muted">é«˜çº§ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ‰€æœ‰ç®—æ³•å‚æ•°ã€‚ä¿®æ”¹åå°†æ ‡è®°ä¸º"è‡ªå®šä¹‰é…ç½®"ã€‚</p>

                        <div class="row">
                            <!-- å·¦ä¾§ï¼šJSONç¼–è¾‘å™¨ -->
                            <div class="col-lg-6">
                                <h6 class="mb-3">é…ç½®æ•°æ®ç¼–è¾‘å™¨</h6>
                                <div id="config-editor">
                                    <textarea class="form-control" id="config-json" rows="35" style="font-family: monospace; font-size: 12px;"></textarea>
                                </div>
                            </div>

                            <!-- å³ä¾§ï¼šå‚æ•°è¯´æ˜é¢æ¿ -->
                            <div class="col-lg-6">
                                <h6 class="mb-3">å‚æ•°è¯´æ˜ <small class="text-muted">ï¼ˆç‚¹å‡»åˆ†ç±»å±•å¼€æŸ¥çœ‹è¯¦æƒ…ï¼‰</small></h6>

                                <div class="accordion" id="paramHelp">
                                    <!-- ç»©æ•ˆç®—æ³•å‚æ•° -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#perf-help">
                                                <strong>ğŸ“Š å·¥ä½œç»©æ•ˆç®—æ³•å‚æ•°</strong>
                                            </button>
                                        </h2>
                                        <div id="perf-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                            <div class="accordion-body" style="font-size: 0.9rem;">
                                                <p class="mb-2"><code>performance.grade_coefficients</code> - <strong>ç­‰çº§ç³»æ•°</strong></p>
                                                <ul class="mb-3">
                                                    <li>å„ç»©æ•ˆç­‰çº§å¯¹åº”çš„ç³»æ•°å€¼ï¼ˆD/C/B/B+/Aï¼‰</li>
                                                    <li>æ•°å€¼è¶Šå°ï¼Œæƒ©ç½šè¶Šä¸¥å‰ï¼ˆD=0.0è¡¨ç¤ºé›¶åˆ†ï¼‰</li>
                                                    <li>ç¤ºä¾‹ï¼šDç­‰çº§ç³»æ•°0.0è¡¨ç¤ºDçº§ç›´æ¥è®°0åˆ†</li>
                                                </ul>

                                                <p class="mb-2"><code>performance.grade_ranges</code> - <strong>ç­‰çº§åˆ†æ•°èŒƒå›´</strong></p>
                                                <ul class="mb-3">
                                                    <li>min/maxï¼šå„ç­‰çº§å¯¹åº”çš„æœ€ä½å’Œæœ€é«˜åˆ†æ•°</li>
                                                    <li>radar_overrideï¼šDçº§ç‰¹æ®Šå¤„ç†çš„é›·è¾¾å›¾æ˜¾ç¤ºåˆ†æ•°</li>
                                                    <li>ç¤ºä¾‹ï¼šDç­‰çº§èŒƒå›´0-79.9ï¼Œé›·è¾¾å›¾å›ºå®šæ˜¾ç¤º50åˆ†</li>
                                                </ul>

                                                <p class="mb-2"><code>performance.contamination_rules</code> - <strong>æ±¡æŸ“è§„åˆ™ï¼ˆç†”æ–­æœºåˆ¶ï¼‰</strong></p>
                                                <ul class="mb-3">
                                                    <li>d_count_thresholdï¼šDçº§å‡ºç°å¤šå°‘æ¬¡è§¦å‘ç†”æ–­ï¼ˆé»˜è®¤1æ¬¡ï¼‰</li>
                                                    <li>c_count_thresholdï¼šCçº§å‡ºç°å¤šå°‘æ¬¡è§¦å‘ç†”æ–­ï¼ˆé»˜è®¤2æ¬¡ï¼‰</li>
                                                    <li>d_cap_scoreï¼šè§¦å‘Dçº§ç†”æ–­åçš„åˆ†æ•°ä¸Šé™ï¼ˆä¸¥æ ¼90åˆ†ï¼‰</li>
                                                    <li>c_cap_scoreï¼šè§¦å‘Cçº§ç†”æ–­åçš„åˆ†æ•°ä¸Šé™ï¼ˆä¸¥æ ¼94.9åˆ†ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šé˜²æ­¢å·®ç­‰çº§å½±å“æ•´ä½“è¯„ä»·</li>
                                                </ul>

                                                <p class="mb-2"><code>performance.time_decay</code> - <strong>æ—¶é—´è¡°å‡æœºåˆ¶</strong> <span class="badge bg-success">æ–°å¢</span></p>
                                                <ul class="mb-0">
                                                    <li>enabledï¼šæ˜¯å¦å¯ç”¨æ—¶é—´è¡°å‡ï¼ˆé»˜è®¤trueï¼‰</li>
                                                    <li>decay_monthsï¼šè¡°å‡çª—å£æœˆæ•°ï¼ˆé»˜è®¤6ä¸ªæœˆï¼‰</li>
                                                    <li>decay_rateï¼šæ¯æœˆè¡°å‡ç‡ï¼ˆé»˜è®¤0.9ï¼Œå³æ¯æœˆè¡°å‡10%ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šè·¨æœˆ/å¹´åº¦è®¡ç®—ä¸­ï¼ŒDçº§/Cçº§å½±å“éšæ—¶é—´å‡å¼±</li>
                                                    <li>ç¤ºä¾‹ï¼š6ä¸ªæœˆå‰çš„Dçº§æœ‰æ•ˆæƒé‡=0.9^6â‰ˆ0.53ï¼Œ7ä¸ªæœˆå‰ä¸è®¡å…¥</li>
                                                    <li><span class="text-info">ä»…åœ¨è·¨æœˆ/å¹´åº¦è®¡ç®—ä¸­ç”Ÿæ•ˆï¼Œæœˆåº¦å¿«ç…§ä¸å¯ç”¨</span></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- å®‰å…¨ç®—æ³•å‚æ•° -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#safety-help">
                                                <strong>ğŸ›¡ï¸ å®‰å…¨æ„è¯†ç®—æ³•å‚æ•°</strong>
                                            </button>
                                        </h2>
                                        <div id="safety-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                            <div class="accordion-body" style="font-size: 0.9rem;">
                                                <p class="mb-2"><code>safety.behavior_track</code> - <strong>è¡Œä¸ºé¢‘ç‡è½¨é“</strong></p>
                                                <ul class="mb-3">
                                                    <li>freq_thresholdsï¼šè¿è§„æ¬¡æ•°é˜ˆå€¼ï¼ˆ2æ¬¡ã€5æ¬¡ã€6æ¬¡ï¼‰</li>
                                                    <li>freq_multipliersï¼šå¯¹åº”çš„æƒ©ç½šå€æ•°ï¼ˆ2å€ã€5å€ã€10å€ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šè¿è§„æ¬¡æ•°è¶Šå¤šï¼Œæƒ©ç½šæˆå€å¢é•¿</li>
                                                </ul>

                                                <p class="mb-2"><code>safety.severity_track</code> - <strong>ä¸¥é‡ç¨‹åº¦è½¨é“</strong></p>
                                                <ul class="mb-3">
                                                    <li>score_rangesï¼šä¸åŒæ‰£åˆ†èŒƒå›´çš„æƒ©ç½šå€æ•°</li>
                                                    <li>ç¤ºä¾‹ï¼šå•æ¬¡æ‰£3åˆ†ä»¥ä¸‹Ã—1.0ï¼Œ3-5åˆ†Ã—2.5ï¼Œ5åˆ†ä»¥ä¸ŠÃ—5.0</li>
                                                    <li>critical_thresholdï¼šé‡å¤§è¿è§„çº¢çº¿ï¼ˆé»˜è®¤12åˆ†ï¼‰</li>
                                                    <li>è¶…è¿‡çº¢çº¿ç›´æ¥åˆ¤å®šä¸ºå®‰å…¨æ„è¯†å·®</li>
                                                </ul>

                                                <p class="mb-2"><code>safety.thresholds</code> - <strong>è¯„åˆ†é˜ˆå€¼</strong></p>
                                                <ul class="mb-0">
                                                    <li>fail_scoreï¼šä¸åˆæ ¼åˆ†æ•°çº¿ï¼ˆä½äº60åˆ†ï¼‰</li>
                                                    <li>warning_scoreï¼šè­¦å‘Šåˆ†æ•°çº¿ï¼ˆä½äº90åˆ†ï¼‰</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- åŸ¹è®­ç®—æ³•å‚æ•° -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#training-help">
                                                <strong>ğŸ“ åŸ¹è®­èƒ½åŠ›ç®—æ³•å‚æ•°</strong>
                                            </button>
                                        </h2>
                                        <div id="training-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                            <div class="accordion-body" style="font-size: 0.9rem;">
                                                <p class="mb-2"><code>training.penalty_rules.absolute_threshold</code> - <strong>ç»å¯¹å¤±æ ¼é˜ˆå€¼</strong></p>
                                                <ul class="mb-3">
                                                    <li>fail_countï¼šå¤±æ ¼æ¬¡æ•°é˜ˆå€¼ï¼ˆé»˜è®¤3æ¬¡ï¼‰</li>
                                                    <li>coefficientï¼šæƒ©ç½šç³»æ•°ï¼ˆé»˜è®¤0.5ï¼Œä¸¥æ ¼0.4ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šå¤±æ ¼æ¬¡æ•°è¾¾æ ‡æ—¶ï¼Œæœ€ç»ˆåˆ†æ•°Ã—ç³»æ•°</li>
                                                </ul>

                                                <p class="mb-2"><code>training.penalty_rules.small_sample</code> - <strong>å°æ ·æœ¬æƒ©ç½š</strong></p>
                                                <ul class="mb-3">
                                                    <li>sample_sizeï¼šæ ·æœ¬é‡é˜ˆå€¼ï¼ˆé»˜è®¤10æ¬¡ï¼‰</li>
                                                    <li>coefficientï¼šæ ·æœ¬ä¸è¶³æ—¶çš„æƒ©ç½šç³»æ•°ï¼ˆ0.7ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šåŸ¹è®­æ¬¡æ•°å°‘æ—¶é€‚åº¦é™ä½åˆ†æ•°</li>
                                                </ul>

                                                <p class="mb-2"><code>training.penalty_rules.afr_thresholds_new_employee</code> - <strong>æ–°å‘˜å·¥AFRé˜ˆå€¼</strong> <span class="badge bg-success">æ–°å¢</span></p>
                                                <ul class="mb-3">
                                                    <li>é€‚ç”¨å¯¹è±¡ï¼šå–è¯å¹´é™<1å¹´çš„æ–°å‘˜å·¥</li>
                                                    <li>AFR = (å¤±æ ¼æ¬¡æ•° / ç»Ÿè®¡å¤©æ•°) Ã— 365</li>
                                                    <li>ä¸åŒé¢‘ç‡åŒºé—´å¯¹åº”ä¸åŒç³»æ•°å’Œæ ‡ç­¾</li>
                                                    <li>ç¤ºä¾‹ï¼šAFRâ‰¥5.0ä¸º"é«˜é¢‘å¤±æ ¼"ï¼Œç³»æ•°0.55ï¼ˆæ›´å®½æ¾ï¼‰</li>
                                                    <li><span class="text-info">æ–°å‘˜å·¥é˜ˆå€¼æ›´å®½æ¾ï¼Œç»™äºˆæˆé•¿ç©ºé—´</span></li>
                                                </ul>

                                                <p class="mb-2"><code>training.penalty_rules.afr_thresholds_experienced</code> - <strong>è€å‘˜å·¥AFRé˜ˆå€¼</strong> <span class="badge bg-success">æ–°å¢</span></p>
                                                <ul class="mb-3">
                                                    <li>é€‚ç”¨å¯¹è±¡ï¼šå–è¯å¹´é™â‰¥1å¹´çš„è€å‘˜å·¥</li>
                                                    <li>AFR = (å¤±æ ¼æ¬¡æ•° / ç»Ÿè®¡å¤©æ•°) Ã— 365</li>
                                                    <li>ä¸åŒé¢‘ç‡åŒºé—´å¯¹åº”ä¸åŒç³»æ•°å’Œæ ‡ç­¾</li>
                                                    <li>ç¤ºä¾‹ï¼šAFRâ‰¥2.5ä¸º"é«˜é¢‘å¤±æ ¼"ï¼Œç³»æ•°0.5ï¼ˆæ ‡å‡†é˜ˆå€¼ï¼‰</li>
                                                    <li><span class="text-info">è€å‘˜å·¥ä½¿ç”¨æ›´ä¸¥æ ¼çš„æ ‡å‡†</span></li>
                                                </ul>

                                                <p class="mb-2"><code>training.duration_thresholds</code> - <strong>æ—¶é•¿é˜ˆå€¼</strong></p>
                                                <ul class="mb-0">
                                                    <li>short_term_daysï¼šçŸ­æœŸç»Ÿè®¡å¤©æ•°ï¼ˆ60å¤©ï¼‰</li>
                                                    <li>mid_term_daysï¼šä¸­æœŸç»Ÿè®¡å¤©æ•°ï¼ˆ180å¤©ï¼‰</li>
                                                    <li>default_scoresï¼šæ— è®°å½•æ—¶çš„é»˜è®¤åˆ†æ•°</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç»¼åˆè¯„åˆ†æƒé‡ -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#weight-help">
                                                <strong>âš–ï¸ ç»¼åˆè¯„åˆ†æƒé‡</strong>
                                            </button>
                                        </h2>
                                        <div id="weight-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                            <div class="accordion-body" style="font-size: 0.9rem;">
                                                <p class="mb-2"><code>comprehensive.score_weights</code> - <strong>äº”ç»´åº¦æƒé‡é…ç½®</strong> <span class="badge bg-warning text-dark">å·²ä¼˜åŒ–</span></p>
                                                <ul class="mb-0">
                                                    <li>performanceï¼šå·¥ä½œç»©æ•ˆæƒé‡ï¼ˆ<del class="text-muted">åŸ35%</del> â†’ <strong>æ–°15%</strong>ï¼Œé™ä½ä»¥æé«˜åŒºåˆ†åº¦ï¼‰</li>
                                                    <li>safetyï¼šå®‰å…¨æ„è¯†æƒé‡ï¼ˆ<strong>ä¿æŒ30%</strong>ï¼Œå®‰å…¨æ˜¯åº•çº¿ï¼‰</li>
                                                    <li>trainingï¼šåŸ¹è®­èƒ½åŠ›æƒé‡ï¼ˆ<strong>ä¿æŒ25%</strong>ï¼Œ25%<30%æ»¡è¶³è¦æ±‚ï¼‰</li>
                                                    <li>stabilityï¼šç¨³å®šæ€§æƒé‡ï¼ˆ<del class="text-muted">åŸ10%</del> â†’ <strong>æ–°15%</strong>ï¼Œæå‡é‡è¦æ€§ï¼‰</li>
                                                    <li>learningï¼šå­¦ä¹ èƒ½åŠ›æƒé‡ï¼ˆ<del class="text-muted">åŸ5%</del> â†’ <strong>æ–°15%</strong>ï¼Œæå‡é‡è¦æ€§ï¼‰</li>
                                                    <li><strong class="text-danger">æ³¨æ„ï¼šäº”é¡¹æƒé‡ä¹‹å’Œå¿…é¡»ç­‰äº1.0</strong></li>
                                                    <li><span class="text-info">ç¨³å®šæ€§å’Œå­¦ä¹ èƒ½åŠ›æƒé‡å¯æ ¹æ®è¿è¡Œåçš„åŒºåˆ†åº¦è°ƒæ•´ï¼ˆåŒºåˆ†åº¦é«˜çš„+5%ï¼Œä½çš„-5%ï¼‰</span></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç¨³å®šæ€§ç®—æ³•å‚æ•° -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#stability-help">
                                                <strong>ğŸ† èŒä¸šç¨³å®šæ€§ç®—æ³•å‚æ•°</strong> <span class="badge bg-success">å…¨æ–°</span>
                                            </button>
                                        </h2>
                                        <div id="stability-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                            <div class="accordion-body" style="font-size: 0.9rem;">
                                                <p class="mb-2"><code>stability.seniority_weights</code> - <strong>èµ„å†ç»´åº¦æƒé‡åˆ†é…</strong></p>
                                                <ul class="mb-3">
                                                    <li>ageï¼šå¹´é¾„æƒé‡ï¼ˆé»˜è®¤0.15ï¼Œå³15%ï¼‰</li>
                                                    <li>working_yearsï¼šå·¥é¾„æƒé‡ï¼ˆé»˜è®¤0.20ï¼Œå³20%ï¼‰</li>
                                                    <li>company_yearsï¼šå¸é¾„æƒé‡ï¼ˆé»˜è®¤0.25ï¼Œå³25%ï¼‰</li>
                                                    <li>cert_yearsï¼šå–è¯å¹´é™æƒé‡ï¼ˆé»˜è®¤0.20ï¼Œå³20%ï¼‰</li>
                                                    <li>solo_yearsï¼šå•ç‹¬é©¾é©¶å¹´é™æƒé‡ï¼ˆé»˜è®¤0.20ï¼Œå³20%ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šç»¼åˆè¯„ä¼°å‘˜å·¥èµ„å†æ°´å¹³</li>
                                                </ul>

                                                <p class="mb-2"><code>stability.seniority_thresholds</code> - <strong>èµ„å†ç»´åº¦å°é¡¶é˜ˆå€¼</strong></p>
                                                <ul class="mb-3">
                                                    <li>age_capï¼šå¹´é¾„å°é¡¶å¹´é™ï¼ˆé»˜è®¤30å¹´ï¼Œæ»¡åˆ†ï¼‰</li>
                                                    <li>working_capï¼šå·¥é¾„å°é¡¶å¹´é™ï¼ˆé»˜è®¤20å¹´ï¼Œæ»¡åˆ†ï¼‰</li>
                                                    <li>company_capï¼šå¸é¾„å°é¡¶å¹´é™ï¼ˆé»˜è®¤10å¹´ï¼Œæ»¡åˆ†ï¼‰</li>
                                                    <li>cert_capï¼šå–è¯å¹´é™å°é¡¶ï¼ˆé»˜è®¤10å¹´ï¼Œæ»¡åˆ†ï¼‰</li>
                                                    <li>solo_capï¼šå•ç‹¬é©¾é©¶å¹´é™å°é¡¶ï¼ˆé»˜è®¤10å¹´ï¼Œæ»¡åˆ†ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šé˜²æ­¢èµ„å†è¿‡é•¿å¯¼è‡´åˆ†æ•°æ— é™å¢é•¿</li>
                                                </ul>

                                                <p class="mb-2"><code>stability.dimension_weights</code> - <strong>ç¨³å®šæ€§ä¸¤ç»´åº¦æƒé‡</strong></p>
                                                <ul class="mb-3">
                                                    <li>seniorityï¼šèµ„å†ç»´åº¦æƒé‡ï¼ˆé»˜è®¤0.60ï¼Œå³60%ï¼‰</li>
                                                    <li>volatilityï¼šè¡¨ç°ç¨³å®šæ€§ç»´åº¦æƒé‡ï¼ˆé»˜è®¤0.40ï¼Œå³40%ï¼‰</li>
                                                    <li>èµ„å†ç»´åº¦ï¼šåŸºäºå¹´é¾„/å·¥é¾„/å¸é¾„/å–è¯å¹´é™/å•ç‹¬é©¾é©¶å¹´é™</li>
                                                    <li>ç¨³å®šæ€§ç»´åº¦ï¼šåŸºäºè¿‡å»ä¸€å¹´ç»©æ•ˆ/å®‰å…¨/åŸ¹è®­åˆ†å€¼çš„æ³¢åŠ¨åº¦ï¼ˆæ ‡å‡†å·®ï¼‰</li>
                                                </ul>

                                                <p class="mb-2"><code>stability.volatility_penalty</code> - <strong>æ³¢åŠ¨æƒ©ç½šå‚æ•°</strong></p>
                                                <ul class="mb-0">
                                                    <li>low_thresholdï¼šä½æ³¢åŠ¨é˜ˆå€¼ï¼ˆé»˜è®¤5.0ï¼Œæ ‡å‡†å·®â‰¤5ä¸ºä½æ³¢åŠ¨ï¼‰</li>
                                                    <li>high_thresholdï¼šé«˜æ³¢åŠ¨é˜ˆå€¼ï¼ˆé»˜è®¤15.0ï¼Œæ ‡å‡†å·®â‰¥15ä¸ºé«˜æ³¢åŠ¨ï¼‰</li>
                                                    <li>max_penaltyï¼šæœ€å¤§æƒ©ç½šç³»æ•°ï¼ˆé»˜è®¤0.5ï¼Œé«˜æ³¢åŠ¨æœ€å¤šæ‰£50%ï¼‰</li>
                                                    <li>ä½œç”¨ï¼šæ³¢åŠ¨è¶Šå¤§ï¼Œç¨³å®šæ€§åˆ†æ•°è¶Šä½</li>
                                                    <li>ç¤ºä¾‹ï¼šæ ‡å‡†å·®5ä»¥ä¸‹æ»¡åˆ†ï¼Œ5-15çº¿æ€§æƒ©ç½šï¼Œ15ä»¥ä¸Šæ‰£50%</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- å…³é”®äººå‘˜åˆ¤å®š -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#key-help">
                                                <strong>ğŸ¯ å…³é”®äººå‘˜åˆ¤å®šæ ‡å‡†</strong>
                                            </button>
                                        </h2>
                                        <div id="key-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                            <div class="accordion-body" style="font-size: 0.9rem;">
                                                <p class="mb-2"><code>key_personnel</code> - <strong>å…³é”®å…³æ³¨äººå‘˜æ ‡å‡†</strong></p>
                                                <ul class="mb-0">
                                                    <li>comprehensive_thresholdï¼šç»¼åˆåˆ†æ•°é˜ˆå€¼ï¼ˆé»˜è®¤70åˆ†ï¼‰</li>
                                                    <li>ä½äºæ­¤åˆ†æ•°çš„äººå‘˜è¢«æ ‡è®°ä¸ºå…³é”®å…³æ³¨å¯¹è±¡</li>
                                                    <li>monthly_violation_thresholdï¼šæœˆåº¦è¿è§„æ¬¡æ•°é˜ˆå€¼ï¼ˆé»˜è®¤3æ¬¡ï¼‰</li>
                                                    <li>è¶…è¿‡æ­¤æ¬¡æ•°çš„äººå‘˜è¢«æ ‡è®°ä¸ºå…³é”®å…³æ³¨å¯¹è±¡</li>
                                                    <li>ä½œç”¨ï¼šè‡ªåŠ¨è¯†åˆ«éœ€è¦é‡ç‚¹ç®¡ç†çš„äººå‘˜</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info mt-3" role="alert">
                                    <strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>æ•°å€¼è¶Šå° = æƒ©ç½šè¶Šä¸¥æ ¼</li>
                                        <li>å»ºè®®å…ˆä½¿ç”¨"æ¨¡æ‹Ÿè®¡ç®—"æµ‹è¯•æ•ˆæœ</li>
                                        <li>ä¿®æ”¹å‰å»ºè®®è®°å½•å˜æ›´åŸå› </li>
                                        <li>æƒé‡é…ç½®æ€»å’Œå¿…é¡»ä¸º1.0</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label for="custom-reason" class="form-label">å˜æ›´åŸå› ï¼š<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="custom-reason" placeholder="è¯·è¾“å…¥å˜æ›´åŸå› ï¼ˆå¿…å¡«ï¼‰" required>
                        </div>

                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-secondary" id="validate-config-btn">
                                <i class="bi bi-check2-square"></i> éªŒè¯é…ç½®
                            </button>
                            <button type="button" class="btn btn-info" id="simulate-btn">
                                <i class="bi bi-play-circle"></i> æ¨¡æ‹Ÿè®¡ç®—
                            </button>
                            <button type="button" class="btn btn-success" id="save-custom-btn">
                                <i class="bi bi-save"></i> ä¿å­˜è‡ªå®šä¹‰é…ç½®
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="reset-btn">
                                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å˜æ›´æ—¥å¿— -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">å˜æ›´æ—¥å¿—</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æ“ä½œç±»å‹</th>
                                    <th>é¢„è®¾æ–¹æ¡ˆ</th>
                                    <th>å˜æ›´åŸå› </th>
                                    <th>æ“ä½œè€…</th>
                                    <th>IPåœ°å€</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body">
                                <tr>
                                    <td colspan="6" class="text-center">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡æ‹Ÿè®¡ç®—æ¨¡æ€æ¡† -->
<div class="modal fade" id="simulateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ¨¡æ‹Ÿè®¡ç®—</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">è¾“å…¥æ ·ä¾‹æ•°æ®ï¼Œé¢„è§ˆæ–°é…ç½®ä¸‹çš„è®¡ç®—ç»“æœï¼š</p>

                <h6>ç»©æ•ˆæ ·ä¾‹ï¼ˆç­‰çº§åˆ—è¡¨ï¼‰ï¼š</h6>
                <input type="text" class="form-control mb-3" id="sample-performance" placeholder='ä¾‹å¦‚: ["D", "C", "B+"]'>

                <h6>å®‰å…¨æ ·ä¾‹ï¼ˆè¿è§„æ‰£åˆ†åˆ—è¡¨ï¼‰ï¼š</h6>
                <input type="text" class="form-control mb-3" id="sample-safety" placeholder='ä¾‹å¦‚: [3, 5, 12]'>

                <h6>åŸ¹è®­æ ·ä¾‹ï¼ˆåˆ†æ•°åˆ—è¡¨,åˆæ ¼åˆ—è¡¨ï¼‰ï¼š</h6>
                <input type="text" class="form-control mb-2" id="sample-training-scores" placeholder='ä¾‹å¦‚: [85, 0, 90]'>
                <input type="text" class="form-control mb-3" id="sample-training-qualified" placeholder='ä¾‹å¦‚: [1, 0, 1]'>

                <hr>
                <div id="simulate-results">
                    <!-- æ¨¡æ‹Ÿç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" id="run-simulate-btn">è¿è¡Œæ¨¡æ‹Ÿ</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentConfig = null;
let selectedPreset = 'standard';

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentConfig();
    loadPresets();
    loadLogs();
});

// åŠ è½½å½“å‰é…ç½®
function loadCurrentConfig() {
    fetch('/system/config/api/current-config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentConfig = data.config;

                // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                const info = data.info;
                let infoHtml = `
                    <p><strong>åŸºäºé¢„è®¾ï¼š</strong> ${info.based_on_preset || 'è‡ªå®šä¹‰'}</p>
                    <p><strong>æ˜¯å¦å·²è‡ªå®šä¹‰ï¼š</strong> ${info.is_customized ? 'æ˜¯' : 'å¦'}</p>
                    <p><strong>æœ€åæ›´æ–°ï¼š</strong> ${info.updated_at || 'æœªçŸ¥'}</p>
                `;
                document.getElementById('current-config-info').innerHTML = infoHtml;

                // å¡«å……JSONç¼–è¾‘å™¨
                document.getElementById('config-json').value = JSON.stringify(currentConfig, null, 2);
            } else {
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('åŠ è½½é…ç½®å¤±è´¥');
        });
}

// åŠ è½½é¢„è®¾æ–¹æ¡ˆ
function loadPresets() {
    fetch('/system/config/api/presets')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('preset-options');
                container.innerHTML = '';

                data.presets.forEach(preset => {
                    const cfg = preset.config_data;
                    const perf = cfg.performance || {};
                    const safety = cfg.safety || {};
                    const training = cfg.training || {};
                    const key = cfg.key_personnel || {};

                    // æå–å…³é”®å‚æ•°
                    const dCap = perf.contamination_rules?.d_cap_score || 90;
                    const cCap = perf.contamination_rules?.c_cap_score || 95;
                    const cThreshold = perf.contamination_rules?.c_count_threshold || 2;
                    const criticalThreshold = safety.severity_track?.critical_threshold || 12;
                    const failCount = training.penalty_rules?.absolute_threshold?.fail_count || 3;
                    const failCoeff = training.penalty_rules?.absolute_threshold?.coefficient || 0.5;
                    const afrHigh = training.penalty_rules?.afr_thresholds?.[0] || {};
                    const keyThreshold = key.comprehensive_threshold || 70;
                    const keyViolation = key.monthly_violation_threshold || 3;

                    const card = `
                        <div class="col-md-4">
                            <div class="card preset-card" data-preset="${preset.preset_key}" style="cursor: pointer; height: 100%;">
                                <div class="card-header bg-${preset.preset_key === 'strict' ? 'danger' : preset.preset_key === 'standard' ? 'primary' : 'success'} text-white">
                                    <h6 class="mb-0"><strong>${preset.preset_name}</strong></h6>
                                </div>
                                <div class="card-body" style="font-size: 0.85rem; overflow-y: auto; max-height: 600px;">
                                    <p class="text-muted mb-3">${preset.description}</p>

                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2"><i class="bi bi-gear-fill"></i> æ ¸å¿ƒå‚æ•°</h6>
                                        <ul class="mb-0" style="padding-left: 1.2rem; line-height: 1.8;">
                                            <li><strong>ç»©æ•ˆç†”æ–­</strong>ï¼šDçº§â‰¥1æ¬¡ â†’ ä¸Šé™<span class="badge bg-warning text-dark">${dCap}åˆ†</span>ï¼ŒCçº§â‰¥${cThreshold}æ¬¡ â†’ ä¸Šé™<span class="badge bg-warning text-dark">${cCap}åˆ†</span></li>
                                            <li><strong>å®‰å…¨çº¢çº¿</strong>ï¼šå•æ¬¡è¿è§„â‰¥<span class="badge bg-danger">${criticalThreshold}åˆ†</span> â†’ ç›´æ¥ä¸åˆæ ¼</li>
                                            <li><strong>åŸ¹è®­æƒ©ç½š</strong>ï¼šå¤±æ ¼â‰¥<span class="badge bg-danger">${failCount}æ¬¡</span> â†’ æƒ©ç½šç³»æ•°<span class="badge bg-danger">${failCoeff}</span></li>
                                            <li><strong>å…³é”®äººå‘˜</strong>ï¼šç»¼åˆåˆ†&lt;<span class="badge bg-warning text-dark">${keyThreshold}</span> æˆ– æœˆå‡è¿è§„â‰¥<span class="badge bg-warning text-dark">${keyViolation}æ¬¡</span></li>
                                        </ul>
                                    </div>

                                    <div class="mb-3">
                                        <h6 class="text-success mb-2"><i class="bi bi-calendar-month"></i> æœˆåº¦è®¡ç®—å…¬å¼</h6>
                                        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem;">
                                            <strong>1ï¸âƒ£ ç»©æ•ˆè¯„åˆ†ï¼š</strong><br>
                                            &nbsp;&nbsp;ç»©æ•ˆåˆ† = ç­‰çº§ç³»æ•° Ã— åŸºå‡†åˆ†(95)<br>
                                            &nbsp;&nbsp;â€¢ Açº§ç³»æ•°=1.1, B+çº§=1.0, Bçº§=0.9, Cçº§=0.6, Dçº§=0.0<br>
                                            <br>
                                            <strong>2ï¸âƒ£ å®‰å…¨è¯„åˆ†ï¼ˆåŒè½¨åˆ¶ï¼‰ï¼š</strong><br>
                                            &nbsp;&nbsp;ç»´åº¦Aï¼ˆè¡Œä¸ºä¹ æƒ¯ï¼‰ï¼šæœˆå‡é¢‘æ¬¡ = âŒˆè¿è§„æ¬¡æ•° / 1âŒ‰<br>
                                            &nbsp;&nbsp;â€¢ é¢‘æ¬¡â‰¤2 â†’ æ‰£åˆ†=é¢‘æ¬¡Ã—2<br>
                                            &nbsp;&nbsp;â€¢ 2&lt;é¢‘æ¬¡â‰¤5 â†’ æ‰£åˆ†=é¢‘æ¬¡Ã—5<br>
                                            &nbsp;&nbsp;â€¢ é¢‘æ¬¡>5 â†’ æ‰£åˆ†=é¢‘æ¬¡Ã—10<br>
                                            &nbsp;&nbsp;ç»´åº¦Bï¼ˆåæœä¸¥é‡æ€§ï¼‰ï¼šæ€»æ‰£åˆ† = Î£(è¿è§„å€¼Ã—ç³»æ•°)<br>
                                            &nbsp;&nbsp;â€¢ è¿è§„&lt;3åˆ† â†’ ç³»æ•°=1.0<br>
                                            &nbsp;&nbsp;â€¢ 3â‰¤è¿è§„&lt;5 â†’ ç³»æ•°=2.5<br>
                                            &nbsp;&nbsp;â€¢ è¿è§„â‰¥5 â†’ ç³»æ•°=5.0<br>
                                            &nbsp;&nbsp;<strong>æœ€ç»ˆåˆ† = min(ç»´åº¦A, ç»´åº¦B)</strong><br>
                                            <br>
                                            <strong>3ï¸âƒ£ åŸ¹è®­è¯„åˆ†ï¼š</strong><br>
                                            &nbsp;&nbsp;åŸºç¡€åˆ† = å¹³å‡åŸ¹è®­æˆç»©<br>
                                            &nbsp;&nbsp;æƒ©ç½šç³»æ•°è§„åˆ™ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š<br>
                                            &nbsp;&nbsp;â€¢ å¤±æ ¼â‰¥${failCount}æ¬¡ â†’ ç³»æ•°=${failCoeff}<br>
                                            &nbsp;&nbsp;â€¢ åŸ¹è®­&lt;10æ¬¡ä¸”æœ‰å¤±æ ¼ â†’ ç³»æ•°=0.6~0.8<br>
                                            &nbsp;&nbsp;â€¢ æŒ‰AFRå¹´åŒ–å¤±æ ¼ç‡è®¡ç®—ï¼ˆè§å¹´åº¦å…¬å¼ï¼‰<br>
                                            &nbsp;&nbsp;<strong>æœ€ç»ˆåˆ† = åŸºç¡€åˆ† Ã— æƒ©ç½šç³»æ•°</strong><br>
                                            <br>
                                            <strong>4ï¸âƒ£ ç»¼åˆè¯„åˆ†ï¼š</strong><br>
                                            &nbsp;&nbsp;ç»¼åˆåˆ† = ç»©æ•ˆÃ—35% + å®‰å…¨Ã—30% + åŸ¹è®­Ã—20%<br>
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ ç¨³å®šÃ—10% + å­¦ä¹ Ã—5%
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <h6 class="text-info mb-2"><i class="bi bi-calendar-range"></i> è·¨æœˆ/å¹´åº¦è®¡ç®—å…¬å¼</h6>
                                        <div style="background-color: #e7f3ff; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem;">
                                            <strong>ğŸ“Š ç»©æ•ˆï¼ˆå‘¨æœŸåŠ æƒï¼‰ï¼š</strong><br>
                                            &nbsp;&nbsp;å¹³å‡ç³»æ•° = (Î£å„æœˆç³»æ•°) / æœˆæ•°<br>
                                            &nbsp;&nbsp;åŸºç¡€åˆ† = å¹³å‡ç³»æ•° Ã— 95<br>
                                            &nbsp;&nbsp;<span class="text-danger"><strong>ç†”æ–­æœºåˆ¶</strong>ï¼šDçº§â‰¥1æ¬¡ â†’ ä¸Šé™${dCap}åˆ†ï¼ŒCçº§â‰¥${cThreshold}æ¬¡ â†’ ä¸Šé™${cCap}åˆ†</span><br>
                                            <br>
                                            <strong>ğŸ›¡ï¸ å®‰å…¨ï¼ˆç´¯ç§¯è¯„ä¼°ï¼‰ï¼š</strong><br>
                                            &nbsp;&nbsp;æœˆå‡é¢‘æ¬¡ = âŒˆè¿è§„æ€»æ¬¡æ•° / æœˆæ•°âŒ‰<br>
                                            &nbsp;&nbsp;æŒ‰æœˆåº¦å…¬å¼çš„é¢‘æ¬¡è§„åˆ™è®¡ç®—æ‰£åˆ†<br>
                                            &nbsp;&nbsp;<span class="text-danger"><strong>é‡å¤§çº¢çº¿</strong>ï¼šä»»ä¸€è¿è§„â‰¥${criticalThreshold}åˆ† â†’ ç›´æ¥ä¸åˆæ ¼</span><br>
                                            <br>
                                            <strong>ğŸ“ åŸ¹è®­ï¼ˆAFRå¹´åŒ–å¤±æ ¼ç‡ï¼‰ï¼š</strong><br>
                                            &nbsp;&nbsp;<span class="text-primary"><strong>AFR = (å¤±æ ¼æ¬¡æ•° / ç»Ÿè®¡å¤©æ•°) Ã— 365</strong></span><br>
                                            &nbsp;&nbsp;ç¤ºä¾‹ï¼š30å¤©å†…å¤±æ ¼2æ¬¡ â†’ AFR=(2/30)Ã—365=24.3æ¬¡/å¹´<br>
                                            &nbsp;&nbsp;<strong>å¹´åŒ–åˆ†æ¡£æƒ©ç½š</strong>ï¼š<br>
                                            &nbsp;&nbsp;â€¢ AFRâ‰¥${afrHigh.min || 2.5}æ¬¡/å¹´ â†’ ç³»æ•°=${afrHigh.coefficient || 0.5} (${afrHigh.label || 'é«˜é¢‘å¤±æ ¼'})<br>
                                            &nbsp;&nbsp;â€¢ 1.5â‰¤AFR&lt;${afrHigh.min || 2.5} â†’ ç³»æ•°=0.6~0.7 (é¢‘ç‡åé«˜)<br>
                                            &nbsp;&nbsp;â€¢ 0.5â‰¤AFR&lt;1.5 â†’ ç³»æ•°=0.85~0.95 (å¶å‘å¤±æ ¼)<br>
                                            &nbsp;&nbsp;â€¢ AFR&lt;0.5 â†’ ç³»æ•°=1.0 (èƒ½åŠ›è¾¾æ ‡)<br>
                                            <br>
                                            <strong>ğŸ“ˆ å­¦ä¹ èƒ½åŠ›ï¼ˆé•¿æœŸè¶‹åŠ¿ï¼‰ï¼š</strong><br>
                                            &nbsp;&nbsp;çº¿æ€§å›å½’æ–œç‡ k = æˆé•¿è¶‹åŠ¿<br>
                                            &nbsp;&nbsp;å­¦ä¹ åˆ† = å¹³å‡ç»¼åˆåˆ† + kÃ—10<br>
                                            &nbsp;&nbsp;â€¢ k>0.5 â†’ æ½œåŠ›è‚¡ï¼ˆæ»¡åˆ†100ï¼‰<br>
                                            &nbsp;&nbsp;â€¢ -0.2â‰¤kâ‰¤0.5 â†’ ç¨³å¥å‹ï¼ˆå¹³å‡åˆ†ï¼‰<br>
                                            &nbsp;&nbsp;â€¢ k&lt;-0.2 â†’ æ‡ˆæ€ å‹ï¼ˆå¹³å‡åˆ†Ã—0.8ï¼‰
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.preset-card').forEach(card => {
                    card.addEventListener('click', function() {
                        // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.preset-card').forEach(c => {
                            c.classList.remove('border-primary', 'bg-light');
                        });
                        // æ·»åŠ é€‰ä¸­çŠ¶æ€
                        this.classList.add('border-primary', 'bg-light');
                        selectedPreset = this.dataset.preset;
                    });
                });

                // é»˜è®¤é€‰ä¸­æ ‡å‡†æ¡£
                const standardCard = document.querySelector('[data-preset="standard"]');
                if (standardCard) {
                    standardCard.click();
                }
            }
        });
}

// åŠ è½½å˜æ›´æ—¥å¿—
function loadLogs() {
    fetch('/system/config/api/change-logs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tbody = document.getElementById('logs-table-body');
                tbody.innerHTML = '';

                if (data.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æš‚æ— æ—¥å¿—è®°å½•</td></tr>';
                    return;
                }

                data.logs.forEach(log => {
                    const row = `
                        <tr>
                            <td>${log.changed_at}</td>
                            <td><span class="badge bg-info">${log.action}</span></td>
                            <td>${log.preset_name || '-'}</td>
                            <td>${log.change_reason}</td>
                            <td>${log.changed_by_name}</td>
                            <td>${log.ip_address || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        });
}

// åº”ç”¨é¢„è®¾æ–¹æ¡ˆ
document.getElementById('apply-preset-btn').addEventListener('click', function() {
    const reason = document.getElementById('preset-reason').value.trim();
    if (!reason) {
        alert('è¯·å¡«å†™å˜æ›´åŸå› ');
        return;
    }

    if (!confirm(`ç¡®å®šè¦åº”ç”¨"${selectedPreset}"é¢„è®¾æ–¹æ¡ˆå—ï¼Ÿ`)) {
        return;
    }

    fetch('/system/config/api/apply-preset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            preset_key: selectedPreset,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('åº”ç”¨æˆåŠŸï¼');
            location.reload();
        } else {
            alert('åº”ç”¨å¤±è´¥: ' + data.error);
        }
    });
});

// éªŒè¯é…ç½®
document.getElementById('validate-config-btn').addEventListener('click', function() {
    try {
        const configData = JSON.parse(document.getElementById('config-json').value);

        fetch('/system/config/api/validate-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({config_data: configData})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.is_valid) {
                alert('âœ… é…ç½®éªŒè¯é€šè¿‡ï¼');
            } else {
                alert('âŒ é…ç½®éªŒè¯å¤±è´¥ï¼š' + data.message);
            }
        });
    } catch (e) {
        alert('JSONæ ¼å¼é”™è¯¯: ' + e.message);
    }
});

// ä¿å­˜è‡ªå®šä¹‰é…ç½®
document.getElementById('save-custom-btn').addEventListener('click', function() {
    const reason = document.getElementById('custom-reason').value.trim();
    if (!reason) {
        alert('è¯·å¡«å†™å˜æ›´åŸå› ');
        return;
    }

    try {
        const configData = JSON.parse(document.getElementById('config-json').value);

        if (!confirm('ç¡®å®šè¦ä¿å­˜è‡ªå®šä¹‰é…ç½®å—ï¼Ÿ')) {
            return;
        }

        fetch('/system/config/api/update-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                config_data: configData,
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ä¿å­˜æˆåŠŸï¼');
                location.reload();
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + data.error);
            }
        });
    } catch (e) {
        alert('JSONæ ¼å¼é”™è¯¯: ' + e.message);
    }
});

// é‡ç½®é…ç½®
document.getElementById('reset-btn').addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºå½“å‰ç”Ÿæ•ˆçš„é…ç½®å—ï¼Ÿ')) {
        loadCurrentConfig();
    }
});

// æ¨¡æ‹Ÿè®¡ç®—
document.getElementById('simulate-btn').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('simulateModal'));
    modal.show();
});

document.getElementById('run-simulate-btn').addEventListener('click', function() {
    try {
        const configData = JSON.parse(document.getElementById('config-json').value);
        const sampleData = {
            performance: {grades: JSON.parse(document.getElementById('sample-performance').value || '["B+"]')},
            safety: {violations: JSON.parse(document.getElementById('sample-safety').value || '[3]')},
            training: {
                scores: JSON.parse(document.getElementById('sample-training-scores').value || '[90]'),
                is_qualified: JSON.parse(document.getElementById('sample-training-qualified').value || '[1]')
            }
        };

        fetch('/system/config/api/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                config_data: configData,
                sample_data: sampleData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySimulateResults(data.results);
            } else {
                alert('æ¨¡æ‹Ÿå¤±è´¥: ' + data.error);
            }
        });
    } catch (e) {
        alert('è¾“å…¥æ•°æ®æ ¼å¼é”™è¯¯: ' + e.message);
    }
});

function displaySimulateResults(results) {
    let html = '<h6>æ¨¡æ‹Ÿç»“æœï¼š</h6>';

    if (results.performance && results.performance.length > 0) {
        html += '<p><strong>ç»©æ•ˆï¼š</strong></p><ul>';
        results.performance.forEach(r => {
            html += `<li>ç­‰çº§ ${r.grade}ï¼šåˆ†æ•° ${r.score}ï¼Œæ ‡ç­¾ ${r.label}</li>`;
        });
        html += '</ul>';
    }

    if (results.safety && results.safety.length > 0) {
        html += '<p><strong>å®‰å…¨ï¼š</strong></p><ul>';
        results.safety.forEach(r => {
            html += `<li>è¿è§„ ${r.violation_score}åˆ†ï¼šæœ€ç»ˆåˆ† ${r.score}ï¼Œæ ‡ç­¾ ${r.label}</li>`;
        });
        html += '</ul>';
    }

    if (results.training && results.training.length > 0) {
        html += '<p><strong>åŸ¹è®­ï¼š</strong></p><ul>';
        results.training.forEach(r => {
            html += `<li>æ ·æœ¬${r.index}ï¼šåˆ†æ•° ${r.final_score}ï¼Œæ ‡ç­¾ ${r.label}</li>`;
        });
        html += '</ul>';
    }

    if (results.errors && results.errors.length > 0) {
        html += '<p class="text-danger"><strong>é”™è¯¯ï¼š</strong></p><ul>';
        results.errors.forEach(err => {
            html += `<li>${err}</li>`;
        });
        html += '</ul>';
    }

    document.getElementById('simulate-results').innerHTML = html;
}
</script>

<style>
.preset-card {
    transition: all 0.3s;
    border: 2px solid transparent;
}

.preset-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.preset-card.border-primary {
    border: 2px solid #0d6efd !important;
}
</style>
{% endblock %}
