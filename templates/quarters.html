{% extends "base.html" %}
{% block content %}
<div class="page-header-card card border-0 shadow-sm mb-4">
  <div class="card-body d-flex flex-column flex-lg-row gap-3 justify-content-between align-items-lg-center">
    <div>
      <h5 class="mb-1">季度绩效 · {{ year }}</h5>
      <div class="text-muted small">按季度汇总月度数据，支持自定义等级颜色与筛选。</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-end">
      <form class="row gy-2 gx-2 align-items-end" method="get" action="{{ url_for('performance.quarters') }}">
        {% for g in selected_grades or [] %}<input type="hidden" name="grade" value="{{ g }}">{% endfor %}
        {% if min_score_filter %}<input type="hidden" name="min_score" value="{{ min_score_filter }}">{% endif %}
        <div class="col-auto">
          <label class="form-label form-label-sm">年份</label>
          <input class="form-control form-control-sm" type="number" name="year" value="{{ year }}" min="2000" max="2100">
        </div>
        <div class="col-auto">
          <button class="btn btn-primary btn-sm" type="submit">切换年份</button>
        </div>
      </form>
      <a class="btn btn-soft-primary btn-sm" href="{{ url_for('performance.export_quarters', year=year, grade=selected_grades, min_score=min_score_filter if min_score_filter else None) }}">导出 Excel</a>
    </div>
  </div>
</div>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0">季度等级选项</h6>
      <small class="text-muted">格式：等级[,颜色] · 留空颜色将采用系统浅色。</small>
    </div>
    <form method="post" class="row gy-2 gx-3 align-items-end">
      <input type="hidden" name="form" value="options">
      <div class="col-12">
        <label class="form-label">等级列表</label>
        <textarea class="form-control" name="grades_input" rows="4" placeholder="优秀,#E6F4EA
良好,#E3F2FD
称职,#FFF8E1
待改进,#FCE4EC
不合格,#FFEBEE">{% for opt in grade_options -%}
{{ opt.grade }}{% if opt.color %},{{ opt.color }}{% endif %}{% if not loop.last %}
{% endif %}{%- endfor %}</textarea>
      </div>
      <div class="col-sm-4 col-md-3">
        <label class="form-label">默认等级</label>
        <select class="form-select form-select-sm" name="default_grade">
          {% for opt in grade_options %}
          <option value="{{ opt.grade }}" {{ 'selected' if opt.is_default else '' }}>{{ opt.grade }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-4 col-md-3 d-grid">
        <button class="btn btn-primary btn-sm" type="submit">保存选项</button>
      </div>
    </form>
  </div>
</div>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <form class="row gy-2 gx-3 align-items-end" method="get" action="{{ url_for('performance.quarters') }}">
      <input type="hidden" name="year" value="{{ year }}">
      <div class="col-md-5">
        <label class="form-label">筛选季度等级</label>
        <select class="form-select" name="grade" multiple size="{{ grade_select_size }}">
          {% for opt in grade_options %}
          <option value="{{ opt.grade }}" {% if opt.grade in (selected_grades or []) %}selected{% endif %}>{{ opt.grade }}</option>
          {% endfor %}
        </select>
        <div class="form-text">按住 Ctrl / ⌘ 可多选</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">季度平均分 ≥</label>
        <input class="form-control" type="number" step="0.01" name="min_score" value="{{ min_score_filter }}">
      </div>
      <div class="col-md-4 d-flex flex-wrap gap-2 align-items-end">
        <button class="btn btn-primary btn-sm" type="submit">应用筛选</button>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('performance.quarters', year=year) }}">清除筛选</a>
      </div>
    </form>
  </div>
</div>

<form method="post">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive table-sticky-head table-sticky-first">
        <table class="table table-modern table-striped table-sm align-middle">
          <thead>
            <tr>
              <th class="sticky-col">人员</th>
              <th colspan="2" class="text-center">Q1 (1-3)</th>
              <th colspan="2" class="text-center">Q2 (4-6)</th>
              <th colspan="2" class="text-center">Q3 (7-9)</th>
              <th colspan="2" class="text-center">Q4 (10-12)</th>
            </tr>
            <tr>
              <th class="sticky-col"></th>
              <th class="text-end text-muted">分</th><th class="text-center text-muted">等</th>
              <th class="text-end text-muted">分</th><th class="text-center text-muted">等</th>
              <th class="text-end text-muted">分</th><th class="text-center text-muted">等</th>
              <th class="text-end text-muted">分</th><th class="text-center text-muted">等</th>
            </tr>
          </thead>
          <tbody>
            {% for r in data %}
            <tr>
              <td class="sticky-col person-cell">
                <div class="person-name">{{ r.name }}</div>
                <div class="person-meta">工号：{{ r.emp_no }}</div>
              </td>
              {% for q in [1,2,3,4] %}
              <td class="text-end">{{ r.q[q].score }}</td>
              {% set cur = r.q[q].grade and r.q[q].grade.strip() or grade_default %}
              {% set cell_color = r.q[q].color if r.q[q].color else '' %}
              <td>
                <div class="d-flex align-items-center gap-2">
                  {% if cell_color %}<span class="grade-color-chip" style="background-color: {{ cell_color }};"></span>{% endif %}
                  <select class="form-select form-select-sm" name="grade_q{{ q }}_{{ r.emp_no }}">
                    {% for opt in grade_options %}
                    <option value="{{ opt.grade }}" {{ 'selected' if cur==opt.grade else '' }}>{{ opt.grade }}{% if opt.is_default %} (默认){% endif %}</option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if not data %}
      <div class="alert alert-warning mb-0 mt-3">未找到季度数据，请先上传月度绩效。</div>
      {% endif %}
    </div>
    <div class="card-footer text-end bg-white">
      <button class="btn btn-primary btn-sm" type="submit">保存季度等级</button>
    </div>
  </div>
</form>
{% endblock %}
